# 阶段3: 配置分层治理方案

> 创建时间: 2026-01-13
> 状态: 规划中

## 1. 当前配置现状

### 配置规模
- **文件**: config.py
- **行数**: 933 行
- **分类数**: 30+ 个配置分类
- **问题**: 单文件过大,难以维护

### 配置分类统计

| 类别 | 配置项 | 重要性 |
|------|--------|--------|
| 交易所配置 | EXCHANGES_CONFIG, ACTIVE_EXCHANGE | 🔴 核心 |
| 策略配置 | ENABLE_STRATEGIES, 策略参数 | 🔴 核心 |
| 风险管理 | STOP_LOSS, TAKE_PROFIT, POSITION_SIZE | 🔴 核心 |
| AI/ML配置 | Claude, ML, Policy Layer | 🟡 扩展 |
| 监控通知 | 飞书, 邮件, Telegram | 🟢 辅助 |
| 技术指标 | RSI, MACD, EMA参数 | 🟡 扩展 |
| 运行时配置 | CHECK_INTERVAL, LOG_LEVEL | 🔴 核心 |
| 套利配置 | ARBITRAGE_*, SPREAD_* | 🟢 辅助 |

## 2. 分层治理方案

### 目录结构设计

```
config/
├── __init__.py                 # 统一导出接口
├── base.py                     # 基础配置（交易所、符号）
├── trading.py                  # 交易配置（杠杆、仓位、止损止盈）
├── strategies.py               # 策略配置
├── risk.py                     # 风险管理配置
├── ai.py                       # AI分析配置（Claude, ML, Policy）
├── monitoring.py               # 监控与通知配置
├── runtime.py                  # 运行时配置
├── arbitrage.py                # 套利引擎配置（可选）
└── indicators.py               # 技术指标参数
```

### 向后兼容层

保留 `config.py` 作为统一入口:

```python
# config.py (新版本 - 薄包装层)
"""
配置统一入口
向后兼容: 导入所有配置子模块的变量
"""
from config.base import *
from config.trading import *
from config.strategies import *
from config.risk import *
from config.ai import *
from config.monitoring import *
from config.runtime import *
from config.arbitrage import *
from config.indicators import *

# 验证配置完整性
from config_validator import validate_config
import sys

if __name__ == "__main__":
    if not validate_config(sys.modules[__name__]):
        raise ValueError("配置验证失败")
```

## 3. 配置模块设计

### 3.1 base.py - 基础配置

**职责**: 交易所连接、交易对、时间周期

```python
# config/base.py
import os
from typing import Dict
from dotenv import load_dotenv

load_dotenv()

# 交易所配置
ACTIVE_EXCHANGE = os.getenv("ACTIVE_EXCHANGE", "bitget")

EXCHANGES_CONFIG: Dict[str, dict] = {
    "bitget": {...},
    "binance": {...},
    "okx": {...},
}

# 当前交易所配置（向后兼容）
EXCHANGE_CONFIG = EXCHANGES_CONFIG[ACTIVE_EXCHANGE]

# 交易对配置
SYMBOL = "BTCUSDT"
PRODUCT_TYPE = "USDT-FUTURES"
TIMEFRAME = "15m"
KLINE_LIMIT = 200

# 多时间周期配置
MULTI_TIMEFRAME_ENABLED = True
TIMEFRAMES = ["5m", "15m", "1h", "4h"]
TIMEFRAME_WEIGHTS = {...}
```

### 3.2 trading.py - 交易配置

**职责**: 杠杆、保证金、仓位管理、止损止盈

```python
# config/trading.py

# 杠杆和保证金
LEVERAGE = 10
MARGIN_MODE = "crossed"

# 仓位管理
POSITION_SIZE_PERCENT = 0.05
MIN_ORDER_USDT = 10
MAX_ORDER_USDT = 1000

# 分批建仓
USE_PARTIAL_POSITION = True
POSITION_PARTS = 3
POSITION_ENTRY_TYPE = "pyramid"

# Kelly公式
USE_KELLY_CRITERION = True
KELLY_FRACTION = 0.6
MIN_WIN_RATE_FOR_KELLY = 0.35

# 止损止盈
STOP_LOSS_PERCENT = 0.045
TAKE_PROFIT_PERCENT = 0.03
TRAILING_STOP_PERCENT = 0.008

# Maker订单配置
USE_MAKER_ORDERS = True
MAKER_ORDER_OFFSET_PCT = 0.0005
...
```

### 3.3 strategies.py - 策略配置

```python
# config/strategies.py

# 启用的策略
ENABLE_STRATEGIES = [
    "macd_cross",
    "ema_cross",
    "bollinger_trend",
]

# 动态策略选择
USE_DYNAMIC_STRATEGY = True

# 策略级止损配置
STRATEGY_STOP_LOSS = {
    "macd_cross": 0.04,
    "ema_cross": 0.045,
    ...
}

# 网格策略
GRID_STRATEGY_ENABLED = False
GRID_LEVELS = 10
...
```

### 3.4 risk.py - 风险管理

```python
# config/risk.py

# 回撤控制
MAX_DAILY_LOSS = 0.10
MAX_DAILY_TRADES = 20
DAILY_LOSS_RESET_HOUR = 0

# 波动率管理
REDUCE_SIZE_ON_HIGH_VOL = True
HIGH_VOLATILITY_THRESHOLD = 0.08

# 订单健康检查
ORDER_HEALTH_CHECK_ENABLED = True
ORDER_MAX_NO_FILL_TIME = 300
...
```

### 3.5 ai.py - AI配置

```python
# config/ai.py
import os

# Claude分析
ENABLE_CLAUDE_ANALYSIS = True
ANTHROPIC_AUTH_TOKEN = os.getenv("ANTHROPIC_AUTH_TOKEN", "")
CLAUDE_MODEL = "claude-sonnet-4.5"
CLAUDE_MAX_TOKENS = 2048

# ML信号过滤
ENABLE_ML_FILTER = True
ML_USE_LITE_VERSION = True
ML_MODE = "shadow"

# Policy Layer
ENABLE_POLICY_LAYER = False
POLICY_LAYER_MODE = "shadow"
POLICY_UPDATE_INTERVAL = 30
...
```

### 3.6 monitoring.py - 监控配置

```python
# config/monitoring.py
import os

# 飞书通知
ENABLE_FEISHU = True
FEISHU_WEBHOOK_URL = os.getenv("FEISHU_WEBHOOK_URL", "")

# 邮件通知
ENABLE_EMAIL = False
EMAIL_HOST = os.getenv("EMAIL_HOST", "")
...

# 状态监控
ENABLE_STATUS_MONITOR = True
STATUS_MONITOR_INTERVAL = 60
...
```

### 3.7 runtime.py - 运行时配置

```python
# config/runtime.py

# 循环间隔
DEFAULT_CHECK_INTERVAL = 5
POSITION_CHECK_INTERVAL = 1
ENABLE_DYNAMIC_CHECK_INTERVAL = True

# 异步配置
USE_ASYNC_DATA_FETCH = True
USE_ASYNC_MAIN_LOOP = False

# 健康检查
AUTO_RECONNECT = True
MAX_API_ERRORS = 10
HEARTBEAT_INTERVAL = 60
...
```

### 3.8 indicators.py - 技术指标

```python
# config/indicators.py

# 趋势指标
EMA_SHORT = 21
EMA_LONG = 55
EMA_SIGNAL = 9

# 动量指标
RSI_PERIOD = 14
RSI_OVERBOUGHT = 70
RSI_OVERSOLD = 30

# MACD
MACD_FAST = 12
MACD_SLOW = 26
MACD_SIGNAL = 9

# 布林带
BB_PERIOD = 20
BB_STD = 2.0
...
```

### 3.9 arbitrage.py - 套利配置

```python
# config/arbitrage.py

ENABLE_ARBITRAGE = False
ARBITRAGE_MODE = "conservative"
ARBITRAGE_SYMBOL = "BTCUSDT"
ARBITRAGE_EXCHANGES = ["bitget", "binance", "okx"]

MIN_SPREAD_THRESHOLD = 0.3
MIN_NET_PROFIT_THRESHOLD = 1.0
...
```

## 4. 实施步骤

### Phase 1: 创建配置模块结构

1. **创建目录**
   ```bash
   mkdir -p config
   ```

2. **创建模块文件**
   - 创建 9 个配置模块文件
   - 每个文件包含对应分类的配置

3. **创建 `__init__.py`**
   - 导出所有配置变量
   - 保持与原 config.py 相同的接口

### Phase 2: 迁移配置内容

**原则**: 小步快跑,逐个模块迁移

1. **迁移 base.py**
   - 复制交易所配置部分
   - 测试导入: `from config.base import *`

2. **迁移 trading.py**
   - 复制交易配置部分
   - 测试: 确保所有交易参数可访问

3. **迁移其他模块** (逐个进行)

### Phase 3: 向后兼容层

1. **重写 config.py**
   ```python
   # config.py
   from config.base import *
   from config.trading import *
   # ... 其他导入
   ```

2. **测试兼容性**
   ```bash
   python -c "import config; print(config.SYMBOL)"
   python -c "import config; print(config.STOP_LOSS_PERCENT)"
   ```

3. **运行完整测试**
   ```bash
   python test_all.py
   ```

### Phase 4: 逐步迁移导入语句

**非强制**: 新代码使用新导入方式

```python
# 旧方式 (仍然支持)
import config
print(config.SYMBOL)

# 新方式 (推荐)
from config.base import SYMBOL
from config.trading import STOP_LOSS_PERCENT
print(SYMBOL)
```

## 5. 风险评估与回滚方案

### 风险点

1. **导入语句失效**
   - 风险: 中等
   - 缓解: 保留 config.py 作为统一入口

2. **配置项遗漏**
   - 风险: 高
   - 缓解: 使用 diff 对比确保完整迁移

3. **动态配置修改**
   - 风险: 低
   - 缓解: config_validator.py 仍然有效

### 回滚方案

```bash
# 备份当前 config.py
cp config.py config.py.backup

# 如果出现问题,恢复备份
rm config.py
mv config.py.backup config.py
rm -rf config/
```

## 6. 验证清单

- [ ] 所有模块文件已创建
- [ ] config/__init__.py 正确导出所有变量
- [ ] config.py 正确导入所有子模块
- [ ] `import config` 仍然有效
- [ ] 运行 `python bot.py` 无导入错误
- [ ] 运行 `python test_all.py` 所有测试通过
- [ ] config_validator.py 验证通过

## 7. 完成标准

**阶段3完成标志:**
- ✅ 配置文件已分层到 9 个模块
- ✅ 向后兼容层 (config.py) 正常工作
- ✅ 所有测试通过
- ✅ 文档更新完成

**预计工作量:**
- 文件创建与迁移: 2-3 小时
- 测试验证: 1 小时
- 总计: 半天

## 8. 后续优化

**未来改进方向:**
1. 配置热重载
2. 配置 UI 界面
3. 多环境配置 (dev/staging/prod)
4. 配置版本控制与回滚

---

**文档维护:**
- 创建者: Claude Sonnet 4.5
- 下一步: 实施 Phase 1 - 创建配置模块结构
