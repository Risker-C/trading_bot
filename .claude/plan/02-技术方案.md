# 交易数据可视化项目 - 技术方案

**文档版本**: v1.0
**创建时间**: 2026-01-09

---

## 1. 方案对比分析

### 方案 A：Python API Gateway + Next.js ⭐ 推荐

**架构概述**：
```
trading_bot (Python) → FastAPI (本地/VPS) → Next.js (Vercel)
                ↓
         SQLite (本地)
```

**技术组成**：
- **后端**：FastAPI + SQLite (WAL) + WebSocket
- **前端**：Next.js 14 + shadcn/ui
- **部署**：API (本地/VPS) + Dashboard (Vercel)

**优点**：
- ✅ 最小迁移成本，复用现有 Python 代码
- ✅ 直接访问本地 SQLite，无需数据同步
- ✅ 支持实时推送（WebSocket/SSE）
- ✅ 保持交易循环不受影响
- ✅ 前后端分离，职责清晰

**缺点**：
- ⚠️ 需要托管 API 服务（本地或云端）
- ⚠️ SQLite 并发读需要优化（WAL 模式）
- ⚠️ 本地部署需要公网访问（ngrok/frp）

**适用场景**：
- 快速启动，最小改动
- 本地或单服务器部署
- 数据量适中（< 100GB）

---

### 方案 B：迁移到 Postgres/Supabase

**架构概述**：
```
trading_bot (Python) → Postgres (云端) ← Next.js (Vercel)
```

**技术组成**：
- **数据库**：PostgreSQL / Supabase
- **后端**：SQLAlchemy / Prisma
- **前端**：Next.js + Supabase Client
- **实时**：Supabase Realtime

**优点**：
- ✅ 多读并发支持，无锁问题
- ✅ 云端备份和高可用
- ✅ 内置实时订阅功能
- ✅ 前端可直接访问数据库

**缺点**：
- ❌ 大量迁移工作（Schema + 代码）
- ❌ 可能影响交易性能（网络延迟）
- ❌ 运维成本增加（数据库费用）
- ❌ 风险高，可能引入回归问题

**适用场景**：
- 长期规划，需要高并发
- 多用户访问
- 数据量大（> 100GB）

---

### 方案 C：事件流镜像 + 消息队列

**架构概述**：
```
trading_bot → SQLite (本地)
     ↓
  Redis/NATS (消息队列)
     ↓
Next.js API Routes → Dashboard
```

**技术组成**：
- **消息队列**：Redis Streams / NATS
- **事件发布**：Python 发布交易事件
- **前端消费**：Next.js API Routes 消费事件

**优点**：
- ✅ 实时推送，无需轮询
- ✅ 解耦 UI 和数据库
- ✅ 可扩展到多消费者

**缺点**：
- ❌ 增加消息队列组件
- ❌ 复杂度高，维护成本大
- ❌ 历史数据仍需查询 SQLite

**适用场景**：
- 需要极低延迟实时推送
- 多个消费者（监控、告警等）
- 微服务架构

---

## 2. 推荐方案详细设计

### 2.1 方案 A 架构设计

**选择理由**：
1. 最小改动，快速上线
2. 复用现有 Python 生态
3. 满足所有功能需求
4. 风险可控

**系统架构图**：

```
┌─────────────────────────────────────────────────────────────┐
│                        用户层                                │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  浏览器 (Chrome/Safari/Firefox)                       │  │
│  │  - React 组件渲染                                     │  │
│  │  - TanStack Query 数据管理                            │  │
│  │  - WebSocket 客户端                                   │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ HTTPS / WSS
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      CDN 层 (Vercel)                         │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Next.js Static Export                                │  │
│  │  - HTML/CSS/JS 静态文件                               │  │
│  │  - 全球 CDN 加速                                      │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ API 请求
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   API 网关层 (本地/VPS)                      │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  FastAPI Application                                  │  │
│  │  ├── REST API 端点                                    │  │
│  │  │   ├── GET /api/trades                             │  │
│  │  │   ├── GET /api/positions/current                  │  │
│  │  │   ├── GET /api/trends/latest                      │  │
│  │  │   ├── GET /api/indicators/active                  │  │
│  │  │   ├── GET /api/history                            │  │
│  │  │   └── POST /api/ai/chat                           │  │
│  │  ├── WebSocket 端点                                   │  │
│  │  │   └── WS /ws/realtime                             │  │
│  │  ├── 认证中间件 (JWT)                                │  │
│  │  └── CORS 中间件                                      │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ 数据查询
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    数据访问层 (本地)                         │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  业务逻辑服务                                         │  │
│  │  ├── TradeService (复用 logger_utils.py)             │  │
│  │  ├── PositionService                                  │  │
│  │  ├── TrendService                                     │  │
│  │  ├── IndicatorService                                 │  │
│  │  ├── HistoryService                                   │  │
│  │  └── AIService (复用 claude_analyzer.py)             │  │
│  └──────────────────────────────────────────────────────┘  │
│                            │                                 │
│                            ▼                                 │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  SQLite Database (WAL 模式)                           │  │
│  │  ├── trades                                           │  │
│  │  ├── trade_tags                                       │  │
│  │  ├── position_snapshots                               │  │
│  │  ├── arbitrage_trades                                 │  │
│  │  └── shadow_decisions                                 │  │
│  └──────────────────────────────────────────────────────┘  │
│                            ▲                                 │
│                            │ 写入                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  trading_bot (Python)                                 │  │
│  │  - 持续运行，写入交易数据                             │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

### 2.2 数据流设计

**读取流程**：
```
1. 用户打开 Dashboard
   ↓
2. Next.js 加载静态页面（Vercel CDN）
   ↓
3. React 组件挂载，发起 API 请求
   ↓
4. TanStack Query 调用 API Client
   ↓
5. FastAPI 接收请求，验证 JWT
   ↓
6. 调用 Service 层查询 SQLite
   ↓
7. 返回 JSON 数据
   ↓
8. React 组件渲染数据
```

**实时推送流程**：
```
1. 用户建立 WebSocket 连接
   ↓
2. FastAPI 验证 JWT，建立连接
   ↓
3. 后台任务监听数据库变化
   ↓
4. 检测到新数据（轮询或触发器）
   ↓
5. 通过 WebSocket 推送增量数据
   ↓
6. 前端接收消息，更新 UI
```

---

### 2.3 技术选型理由

**后端：FastAPI**
- ✅ Python 生态，与 trading_bot 一致
- ✅ 高性能（基于 Starlette + Pydantic）
- ✅ 自动生成 OpenAPI 文档
- ✅ 原生支持 WebSocket
- ✅ 异步支持（async/await）

**前端：Next.js 14**
- ✅ React 生态，组件丰富
- ✅ App Router，现代化路由
- ✅ 服务端渲染（SSR）可选
- ✅ 静态导出，部署简单
- ✅ Vercel 原生支持

**UI 库：shadcn/ui**
- ✅ 基于 Radix UI，可访问性好
- ✅ Tailwind CSS，样式灵活
- ✅ 组件可定制，非 npm 包
- ✅ 现代化设计，美观
- ✅ TypeScript 支持完善

**图表库：Recharts**
- ✅ React 原生，易集成
- ✅ 声明式 API，简单易用
- ✅ 响应式设计
- ✅ 支持多种图表类型
- ✅ 轻量级（相比 ECharts）

---

### 2.4 安全设计

**认证机制**：
```python
# JWT Token 结构
{
  "sub": "user_id",
  "exp": 1704844800,  # 过期时间
  "iat": 1704758400,  # 签发时间
  "scopes": ["read", "write"]
}
```

**API 安全**：
1. **HTTPS 加密**：所有 API 请求使用 HTTPS
2. **JWT 认证**：每个请求携带 Bearer Token
3. **CORS 限制**：只允许特定域名访问
4. **速率限制**：防止 API 滥用（每分钟 60 次）
5. **输入验证**：Pydantic 模型验证所有输入

**密钥管理**：
- Claude API Key 仅存储在后端环境变量
- JWT Secret 使用强随机字符串
- 数据库路径不暴露给前端

---

### 2.5 性能优化

**后端优化**：
1. **SQLite WAL 模式**：允许并发读
2. **连接池**：复用数据库连接
3. **查询优化**：添加索引，优化 SQL
4. **缓存层**：Redis 缓存热点数据（可选）
5. **异步处理**：使用 async/await

**前端优化**：
1. **代码分割**：按路由分割代码
2. **懒加载**：图表组件按需加载
3. **数据缓存**：TanStack Query 自动缓存
4. **虚拟滚动**：长列表使用虚拟滚动
5. **图片优化**：Next.js Image 组件

---

### 2.6 可扩展性设计

**水平扩展**：
- API 服务可部署多实例（负载均衡）
- WebSocket 使用 Redis Pub/Sub 同步

**垂直扩展**：
- 数据库迁移到 Postgres（方案 B）
- 引入消息队列（方案 C）

**功能扩展**：
- 插件系统：支持自定义指标
- 多用户：添加用户管理模块
- 多交易所：扩展到其他交易所

---

## 3. 技术风险与缓解

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| SQLite 写锁阻塞读 | 中 | 高 | 启用 WAL，设置 busy_timeout=5000 |
| WebSocket 连接断开 | 高 | 中 | 自动重连 + 心跳检测 |
| API 响应慢 | 中 | 中 | 添加索引 + 缓存 + 分页 |
| 内存泄漏 | 低 | 高 | 定期重启 + 监控内存使用 |
| 跨域问题 | 低 | 低 | 正确配置 CORS |

---

## 4. 部署方案

### 4.1 开发环境

```bash
# 后端
cd apps/api
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
uvicorn main:app --reload --port 8000

# 前端
cd apps/dashboard
npm install
npm run dev  # 端口 3000
```

### 4.2 生产环境

**后端部署（本地/VPS）**：
```bash
# 使用 systemd 管理服务
sudo systemctl start trading-api
sudo systemctl enable trading-api

# 或使用 Docker
docker build -t trading-api .
docker run -d -p 8000:8000 trading-api
```

**前端部署（Vercel）**：
```bash
# 连接 GitHub 仓库
vercel link

# 部署
vercel --prod
```

**公网访问（开发阶段）**：
```bash
# 使用 ngrok 暴露本地 API
ngrok http 8000
# 获得公网 URL: https://xxx.ngrok.io
```

---

## 5. 监控与运维

**监控指标**：
- API 响应时间（P50, P95, P99）
- WebSocket 连接数
- 数据库查询时间
- 错误率
- 内存/CPU 使用率

**日志管理**：
- 结构化日志（JSON 格式）
- 日志级别：DEBUG, INFO, WARNING, ERROR
- 日志轮转（按天或按大小）

**告警机制**：
- API 响应时间 > 1s
- 错误率 > 5%
- WebSocket 连接失败率 > 10%

---

**下一步**：阅读 `03-后端API设计.md` 了解详细的 API 接口设计。
