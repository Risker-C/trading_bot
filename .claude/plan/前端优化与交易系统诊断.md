# 前端优化与交易系统诊断实施计划

**创建时间**: 2026-01-15
**状态**: ✅ 已批准,实施中

---

## 📋 需求概述

### 用户需求
1. **前端优化**: 删减历史交易数据展示,聚焦实时行情/K线/指标/决策信息
2. **交易诊断**: 分析为何近一个月未交易,修复逻辑缺陷并优化策略

### 用户偏好确认
- ✅ 保留独立/trades页面供审计
- ✅ 主界面(首页+监控页)完全移除历史展示
- ✅ 决策信息包含: 策略信号/风控状态/市场状态/下单建议
- ✅ 诊断目标: 修复逻辑缺陷并优化策略

---

## 🔍 问题根因分析(Codex)

### 核心问题: 多层门槛叠加导致长期无交易

**1. 信号层面** (`core/trader.py:464-514`)
- 策略需要 ≥50 根K线数据
- 市场状态过滤: 震荡期只用2个策略,趋势期强制用3个特定策略
- 共识模式下需多个策略达成一致(MIN_STRATEGY_AGREEMENT)
- 信号强度/置信度阈值偏高(MIN_SIGNAL_STRENGTH=0.40, MIN_SIGNAL_CONFIDENCE=0.30)

**2. 风控层面** (`risk/risk_manager.py:323-384`)
- 持仓排他检查
- 冷却机制(trade_cooldown/loss_cooldown可能未按日重置)
- 日内限制(交易次数≥20或亏损<-500 USDT即拒绝)

**3. 执行层面**
- 最小下单额检查: 若计算仓位<MIN_ORDER_USDT或超余额80%则返回0
- 执行过滤器(`risk/execution_filter.py`): 点差/滑点/流动性/波动性任一不通过即拒单
- **关键缺陷**: 失败原因未暴露给前端,无可观测性

**4. 引擎层面** (`core/engine.py:79-95`)
- 风控拒绝后直接短路返回,仅记录risk_rejected事件
- 缺乏长期无交易的健康警示

---

## 🎨 前端优化方案(Gemini)

### 组件清理方案

**需移除**:
- ❌ `apps/dashboard/app/page.tsx` 底部的"最近交易"表格(line 92-124)
- ❌ `apps/dashboard/app/monitor/page.tsx` 的"最新交易信号"列表(line 99-116)

**保留**:
- ✅ `apps/dashboard/app/trades/page.tsx` (独立审计页)

### 决策信息面板设计

**新组件**: `components/DecisionPanel.tsx`

**UI结构**:
```
┌─────────────────────────────────────────────────┐
│ 📊 Bot决策中心                                    │
├─────────────────────────────────────────────────┤
│ 信号强度: ████████░░ 75% (强多头信号)              │
│ 市场状态: 🔄 震荡市 (ADX: 18.5)                    │
│ 风控状态: ⚠️ 冷却中 (剩余58秒)                      │
│ 阻断原因: ⛔ 点差过大 (0.15% > 0.10%)              │
│ 建议操作: 🚫 观望等待                              │
└─────────────────────────────────────────────────┘
```

**数据源**: WebSocket新增`decision`频道

**K线图表**: TradingView Lightweight Charts (轻量高性能)

---

## 📐 实施方案

### 方案选择

| 方案 | 描述 | 优势 | 风险 | 选择 |
|------|------|------|------|------|
| A: 暴露决策API | 仅增加可观测性 | 无风险,快速 | 不解决交易频率 | ✅ 优先 |
| B: 调低阈值 | 降低信号/风控门槛 | 提升交易频率 | 可能降低质量 | ⚠️ 后续评估 |
| C: 状态机优化 | 修复冷却/计数器逻辑 | 低风险,可持续 | 实施复杂度中等 | ✅ 并行 |

**最终方案**: A+C组合,分步实施

---

## 🚀 实施步骤

### Phase 4: 前端界面优化

**任务清单**:
1. ✅ 移除首页历史交易表格
2. ✅ 移除监控页交易信号列表
3. ✅ 优化页面布局,为决策面板预留空间

### Phase 5: 决策信息面板

**后端任务**:
1. 新增`/api/decisions/status` API
2. WebSocket新增`decision`频道
3. 聚合策略信号/风控状态/执行过滤结果

**前端任务**:
1. 创建`DecisionPanel`组件
2. WebSocketContext扩展支持`decision`频道
3. 集成TradingView K线图表

### Phase 6: 交易系统修复

**修复清单**:
1. 风控计数器按日重置(`risk/risk_manager.py`)
2. 最小下单额失败日志记录
3. 执行过滤器拒绝原因暴露
4. 冷却剩余时间计算并暴露

### Phase 7: 代码审查

**多模型审查**:
- Codex: 后端逻辑/安全/性能
- Gemini: 前端可访问性/设计一致性

### Phase 8: 质量审查与交付

---

## 📊 技术规格

### 后端API设计

```python
# GET /api/decisions/status
{
  "signal_strength": 0.75,
  "signal_confidence": 0.68,
  "signal_type": "long",
  "market_state": "ranging",
  "market_adx": 18.5,
  "risk_status": {
    "can_trade": false,
    "reason": "交易冷却中",
    "cooldown_remaining": 58
  },
  "drawdown_status": {
    "allowed": true,
    "current_drawdown_pct": 2.5
  },
  "execution_filters": {
    "spread_ok": false,
    "spread_value": 0.15,
    "spread_threshold": 0.10,
    "slippage_ok": true,
    "volatility_ok": true
  },
  "blocking_reasons": ["点差过大 (0.15% > 0.10%)"],
  "order_suggestion": "hold",
  "entry_price_range": null,
  "logic_chain": [
    {"step": "RSI检查", "result": "35 (超卖)", "passed": true},
    {"step": "MACD检查", "result": "金叉 (+120)", "passed": true},
    {"step": "风控检查", "result": "冷却中", "passed": false},
    {"step": "执行过滤", "result": "点差过大", "passed": false}
  ]
}
```

### 前端组件结构

```
components/
├── DecisionPanel.tsx       # 决策信息主面板
├── charts/
│   └── KLineChart.tsx      # K线图表组件
└── ui/                     # shadcn/ui组件(已存在)
```

---

## ⚠️ 风险控制

1. **不调整策略阈值**: 暂不修改MIN_SIGNAL_STRENGTH等参数,等监控数据后评估
2. **渐进式实施**: 前端优化 → API开发 → 系统修复 → 参数调优
3. **回滚方案**: 保留/trades页面作为历史数据备份入口

---

## 📈 预期效果

1. **可观测性**: 用户可清晰看到Bot为何不交易
2. **用户体验**: 首屏空间释放40%+,聚焦实时决策
3. **系统健康**: 修复冷却/计数器逻辑缺陷
4. **后续优化**: 基于监控数据优化策略参数

---

**Codex SESSION_ID**: `019bc083-dca1-7780-9b82-9c0bb168c7ba`
**Gemini SESSION_ID**: `c9deddfd-3311-43af-946a-e51c06158f44`
