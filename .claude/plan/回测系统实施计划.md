# å›æµ‹ç³»ç»Ÿå®æ–½è®¡åˆ’

**æ–¹æ¡ˆ**ï¼šæ²‰æµ¸å¼å¤šé¢æ¿æ–¹æ¡ˆ
**ç”Ÿæˆæ—¶é—´**ï¼š2026-01-16
**Codex Session**: 019bc469-e82d-7ed3-a1ae-7ea10dbdd549
**Gemini Session**: 723fa0d4-fe1a-4ee1-86fd-55ab086a576f

---

## ğŸ“‹ éœ€æ±‚æ¦‚è¿°

åœ¨ dashboard ä¸­æ–°å¢å›æµ‹ï¼ˆBacktestingï¼‰åŠŸèƒ½é¡µé¢ï¼Œæ”¯æŒï¼š

### å‰ç«¯éœ€æ±‚
- **UIå¸ƒå±€**ï¼šä¸Šæ–¹ KLineChart å±•ç¤ºKçº¿+æŒä»“+ä¹°å–ç‚¹ï¼Œä¸‹æ–¹ Tabs å±•ç¤ºæŒä»“/äº¤æ˜“è®°å½•
- **åŠŸèƒ½**ï¼šå‚æ•°é…ç½®ã€å®æ—¶è¿›åº¦ã€ç»“æœç»Ÿè®¡ã€äº¤æ˜“è¯¦æƒ…æŸ¥çœ‹ã€æŠ¥å‘Šå¯¼å‡ºã€åº”ç”¨åˆ°å®ç›˜

### åç«¯éœ€æ±‚
- **æ•°æ®è·å–**ï¼šä» Bitget API è·å–å†å²Kçº¿
- **å›æµ‹å¼•æ“**ï¼šæ—¶é—´æ­¥æ¨è¿› + ç­–ç•¥åº”ç”¨ + è®¢å•æ¨¡æ‹Ÿ
- **ç‹¬ç«‹æ•°æ®åº“**ï¼šbacktest.db å­˜å‚¨å›æµ‹æ•°æ®
- **ç­–ç•¥ç®¡ç†**ï¼šæ”¯æŒä¿®æ”¹å®ç›˜ç­–ç•¥ã€æ‰©å±•æ–°ç­–ç•¥
- **æŠ¥å‘Šç”Ÿæˆ**ï¼šPDF/Excel æ ¼å¼

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### åç«¯æ¶æ„ï¼ˆCodexï¼‰

#### æ¨¡å—å¸ƒå±€
```
backtest/
  __init__.py
  models.py                 # Kline, Signal, Order, Position, Metrics
  data_provider.py          # HistoricalDataProvider + Bitget å®ç°
  cache.py                  # KlineCache
  engine.py                 # BacktestEngine
  simulator.py              # OrderSimulator + Portfolio
  metrics.py                # MetricsCalculator
  repository.py             # BacktestRepository (SQLite IO)
  report.py                 # ReportExporter (CSV/Excel/PDF)
  task_manager.py           # BacktestTaskManager

apps/api/
  models/backtest.py        # Pydantic æ¨¡å‹
  routes/backtest.py        # REST ç«¯ç‚¹
  routes/backtest_stream.py # WebSocket ç«¯ç‚¹
  services/backtest_service.py
```

#### æ ¸å¿ƒç»„ä»¶
- **BacktestService**: API ç¼–æ’ã€è¾“å…¥éªŒè¯ã€æƒé™æ£€æŸ¥
- **BacktestTaskManager**: å¯åŠ¨/åœæ­¢ä»»åŠ¡ã€çŠ¶æ€è·Ÿè¸ªã€WS æ¨é€
- **HistoricalDataProvider**: åˆ†é¡µã€é™é¢‘ã€é‡è¯•ã€ç¼“å­˜
- **BacktestEngine**: æ—¶é—´æ­¥å¾ªç¯ã€ä¿¡å·è¯„ä¼°
- **OrderSimulator**: è™šæ‹Ÿæˆäº¤ã€æ‰‹ç»­è´¹/æ»‘ç‚¹ã€Portfolio æ›´æ–°
- **MetricsCalculator**: æ”¶ç›Šç‡ã€èƒœç‡ã€æœ€å¤§å›æ’¤ã€å¤æ™®æ¯”ç‡
- **BacktestRepository**: æŒä¹…åŒ–ä¼šè¯ã€äº¤æ˜“ã€æŒä»“ã€äº‹ä»¶ã€æŒ‡æ ‡

#### æ•°æ®åº“ Schema
```sql
-- backtest_sessions: å›æµ‹ä¼šè¯
-- backtest_klines: Kçº¿ç¼“å­˜
-- backtest_events: äº‹ä»¶æ ‡è®°ï¼ˆä¿¡å·/è®¢å•ï¼‰
-- backtest_trades: äº¤æ˜“è®°å½•
-- backtest_positions: æŒä»“è®°å½•
-- backtest_metrics: ç»Ÿè®¡æŒ‡æ ‡
-- backtest_equity_curve: æƒç›Šæ›²çº¿
```

#### API è·¯ç”±
**REST** (`/api/backtests`):
- `POST /sessions` - åˆ›å»ºä¼šè¯
- `POST /sessions/{id}/start` - å¯åŠ¨å›æµ‹
- `POST /sessions/{id}/stop` - åœæ­¢å›æµ‹
- `GET /sessions/{id}` - ä¼šè¯è¯¦æƒ…
- `GET /sessions/{id}/metrics` - æŒ‡æ ‡å¿«ç…§
- `GET /sessions/{id}/trades` - äº¤æ˜“è®°å½•
- `GET /sessions/{id}/positions` - æŒä»“è®°å½•
- `GET /sessions/{id}/klines` - Kçº¿æ•°æ®
- `GET /sessions/{id}/events` - äº‹ä»¶æ ‡è®°
- `POST /sessions/{id}/export` - å¯¼å‡ºæŠ¥å‘Š
- `POST /sessions/{id}/apply` - åº”ç”¨åˆ°å®ç›˜ï¼ˆç®¡ç†å‘˜ï¼‰

**WebSocket** (`/ws/backtests/{id}`):
- `backtest.progress` - è¿›åº¦æ›´æ–°
- `backtest.trade` - äº¤æ˜“äº‹ä»¶
- `backtest.event` - ä¿¡å·äº‹ä»¶
- `backtest.metric` - æŒ‡æ ‡æ›´æ–°
- `backtest.done` - å®Œæˆ
- `backtest.error` - é”™è¯¯

---

### å‰ç«¯æ¶æ„ï¼ˆGeminiï¼‰

#### ç»„ä»¶æ ‘
```
BacktestPage (app/backtest/page.tsx)
â”œâ”€â”€ BacktestProvider (Zustand Store)
â””â”€â”€ BacktestLayout
    â”œâ”€â”€ ResizablePanelGroup (Horizontal)
    â”‚   â”œâ”€â”€ ResizablePanel (20% - é…ç½®ä¾§è¾¹æ )
    â”‚   â”‚   â””â”€â”€ ConfigSidebar
    â”‚   â””â”€â”€ ResizablePanel (80% - ä¸»åŒºåŸŸ)
    â”‚       â””â”€â”€ ResizablePanelGroup (Vertical)
    â”‚           â”œâ”€â”€ ResizablePanel (65% - å›¾è¡¨)
    â”‚           â”‚   â””â”€â”€ KLineChartContainer
    â”‚           â”‚       â”œâ”€â”€ ChartToolbar
    â”‚           â”‚       â””â”€â”€ KLineChartWrapper
    â”‚           â””â”€â”€ ResizablePanel (35% - æ•°æ®)
    â”‚               â””â”€â”€ BacktestDataTabs
    â”‚                   â”œâ”€â”€ SummaryTab
    â”‚                   â”œâ”€â”€ TradesTab (è™šæ‹Ÿæ»šåŠ¨)
    â”‚                   â”œâ”€â”€ PositionsTab (è™šæ‹Ÿæ»šåŠ¨)
    â”‚                   â””â”€â”€ LogsTab
```

#### çŠ¶æ€ç®¡ç†ï¼ˆZustandï¼‰
- **Execution State**: status, progress, currentSessionId
- **Config State**: params (symbol, interval, dateRange, capital, strategy)
- **UI State**: activeTradeId, visibleIndicators, chartMarkers
- **Data Cache**: klines, trades, positions

#### è·¯ç”±è®¾è®¡
- `/backtest` - ä¸»é¡µé¢
- `/backtest/[id]` - æŸ¥çœ‹å†å²å›æµ‹ç»“æœ
- æ”¯æŒ URL å‚æ•°ï¼š`?strategy=xxx&interval=1h`

#### å“åº”å¼å¸ƒå±€
- **Desktop (Lg+)**: `react-resizable-panels` ä¸‰æ®µå¼å¸ƒå±€
- **Tablet (Md)**: ä¾§è¾¹æ è½¬ä¸º `Sheet` å¼¹å‡ºå¼
- **Mobile (Sm)**: å…¨å± `Tabs` åˆ‡æ¢

#### KLineChart é›†æˆ
- **Markers**: `chart.createAnnotation` æ¸²æŸ“ä¹°å–ç‚¹ç®­å¤´
- **è”åŠ¨**:
  - è¡¨æ ¼ â†’ å›¾è¡¨ï¼š`chart.scrollToTimestamp(ts)`
  - å›¾è¡¨ â†’ è¡¨æ ¼ï¼š`virtualizer.scrollToIndex()`
- **æ€§èƒ½ä¼˜åŒ–**: Canvas æ¨¡å¼ + `requestAnimationFrame` ç¼“å†²

---

## ğŸ“ å®æ–½æ­¥éª¤

### Phase 1: åŸºç¡€è®¾æ–½ï¼ˆP0ï¼‰

#### åç«¯
1. **æ•°æ®åº“ Schema**
   - åˆ›å»º `docs/backtesting_schema.sql`
   - å®ç° `backtest/repository.py` (WAL + busy_timeout)
   - åˆå§‹åŒ– `backtest.db`

2. **API å¥‘çº¦**
   - åˆ›å»º `apps/api/models/backtest.py` (Pydantic æ¨¡å‹)
   - åˆ›å»º `apps/api/routes/backtest.py` (REST ç«¯ç‚¹)
   - æ³¨å†Œè·¯ç”±åˆ° `apps/api/main.py`

3. **æ•°æ®æä¾›è€…**
   - å®ç° `backtest/data_provider.py` (HistoricalDataProvider)
   - å®ç° `backtest/cache.py` (KlineCache)
   - é›†æˆ Bitget é€‚é…å™¨ï¼Œæ”¯æŒåˆ†é¡µå’Œé™é¢‘

#### å‰ç«¯
1. **è·¯ç”±å’Œå¸ƒå±€**
   - åˆ›å»º `apps/dashboard/app/backtest/page.tsx`
   - å®‰è£… `react-resizable-panels`
   - å®ç°åŸºç¡€ä¸‰æ®µå¼å¸ƒå±€

2. **çŠ¶æ€ç®¡ç†**
   - åˆ›å»º `apps/dashboard/stores/useBacktestStore.ts` (Zustand)
   - å®šä¹‰ API æ¥å£ç±»å‹ `apps/dashboard/types/backtest.ts`

---

### Phase 2: æ ¸å¿ƒåŠŸèƒ½ï¼ˆP1ï¼‰

#### åç«¯
1. **å›æµ‹å¼•æ“**
   - å®ç° `backtest/engine.py` (æ—¶é—´æ­¥å¾ªç¯)
   - å®ç° `backtest/simulator.py` (OrderSimulator + Portfolio)
   - é›†æˆç­–ç•¥é€‚é…å™¨ï¼ˆå¤ç”¨ `strategies/strategies.py`ï¼‰

2. **æŒ‡æ ‡è®¡ç®—**
   - å®ç° `backtest/metrics.py` (MetricsCalculator)
   - æ”¯æŒï¼šæ€»æ”¶ç›Šã€èƒœç‡ã€æœ€å¤§å›æ’¤ã€å¤æ™®æ¯”ç‡ã€ç›ˆäºæ¯”

3. **WebSocket æµ**
   - åˆ›å»º `apps/api/routes/backtest_stream.py`
   - å®ç°è¿›åº¦æ¨é€ã€äº¤æ˜“äº‹ä»¶ã€æŒ‡æ ‡æ›´æ–°

#### å‰ç«¯
1. **å›¾è¡¨é›†æˆ**
   - å®‰è£… `klinecharts`
   - åˆ›å»º `apps/dashboard/components/backtest/KLineChartWrapper.tsx`
   - å®ç°åŸºç¡€ K çº¿æ¸²æŸ“

2. **é…ç½®ä¾§è¾¹æ **
   - åˆ›å»º `apps/dashboard/components/backtest/ConfigSidebar.tsx`
   - ä½¿ç”¨ `react-hook-form` + `zod` æ ¡éªŒ
   - å®ç°åŸºç¡€å‚æ•°è¡¨å•ï¼ˆæ—¶é—´ã€èµ„é‡‘ã€å‘¨æœŸï¼‰

3. **æ•°æ®å±•ç¤º**
   - åˆ›å»º `apps/dashboard/components/backtest/SummaryTab.tsx`
   - åˆ›å»º `apps/dashboard/components/backtest/TradesTab.tsx` (è™šæ‹Ÿæ»šåŠ¨)
   - å¯¹æ¥åç«¯ API

---

### Phase 3: äº¤äº’å¢å¼ºï¼ˆP2ï¼‰

#### åç«¯
1. **ä»»åŠ¡ç®¡ç†**
   - å®ç° `backtest/task_manager.py` (BacktestTaskManager)
   - æ”¯æŒå¯åŠ¨/åœæ­¢/çŠ¶æ€æŸ¥è¯¢
   - çº¿ç¨‹æ± éš”ç¦»

2. **æŠ¥å‘Šå¯¼å‡º**
   - å®ç° `backtest/report.py` (ReportExporter)
   - æ”¯æŒ CSV/Excel æ ¼å¼
   - PDF ä½œä¸ºå¼‚æ­¥ä»»åŠ¡æ‰©å±•

#### å‰ç«¯
1. **å›¾è¡¨æ ‡è®°**
   - å®ç°ä¹°å–ç‚¹ Marker æ¸²æŸ“
   - å®ç°å›¾è¡¨ä¸è¡¨æ ¼åŒå‘è”åŠ¨
   - æ·»åŠ  Marker ç‚¹å‡»è¯¦æƒ…å¼¹çª—

2. **WebSocket é›†æˆ**
   - æ‰©å±• `WebSocketContext` æ”¯æŒå›æµ‹é¢‘é“
   - å®ç°å®æ—¶è¿›åº¦æ¡
   - å®ç°å®æ—¶äº¤æ˜“äº‹ä»¶æ¨é€

3. **ç­–ç•¥å‚æ•°åŠ¨æ€è¡¨å•**
   - ç›‘å¬ç­–ç•¥åˆ‡æ¢
   - é€šè¿‡ API è·å–ç­–ç•¥é»˜è®¤å‚æ•°
   - åŠ¨æ€æ¸²æŸ“é…ç½®è¡¨å•

---

### Phase 4: é«˜çº§åŠŸèƒ½ï¼ˆP3ï¼‰

#### åç«¯
1. **åº”ç”¨åˆ°å®ç›˜**
   - å®ç° `/sessions/{id}/apply` ç«¯ç‚¹
   - æ·»åŠ ç®¡ç†å‘˜æƒé™æ£€æŸ¥
   - è®°å½•å®¡è®¡æ—¥å¿—

2. **ç­–ç•¥æ‰©å±•**
   - è®¾è®¡ç­–ç•¥æ’ä»¶æ¥å£
   - æ”¯æŒçƒ­æ›´æ–°ç­–ç•¥é…ç½®

#### å‰ç«¯
1. **æŠ¥å‘Šå¯¼å‡º**
   - å®ç°å¯¼å‡ºæŒ‰é’®
   - æ”¯æŒ CSV/Excel ä¸‹è½½
   - æ˜¾ç¤ºå¯¼å‡ºè¿›åº¦

2. **åº”ç”¨åˆ°å®ç›˜**
   - å®ç°"åº”ç”¨åˆ°å®ç›˜"æŒ‰é’®
   - æ·»åŠ äºŒæ¬¡ç¡®è®¤å¯¹è¯æ¡†
   - æ˜¾ç¤ºåº”ç”¨ç»“æœ

---

## ğŸ”’ å®‰å…¨ä¸æ€§èƒ½è€ƒè™‘

### å®‰å…¨
- **æƒé™æ§åˆ¶**: "åº”ç”¨åˆ°å®ç›˜"éœ€è¦ç®¡ç†å‘˜æƒé™
- **å®¡è®¡æ—¥å¿—**: è®°å½•æ‰€æœ‰ç­–ç•¥ä¿®æ”¹æ“ä½œ
- **è¾“å…¥éªŒè¯**: æ—¶é—´èŒƒå›´ç™½åå•ã€æœ€å¤§æ—¥æœŸèŒƒå›´é™åˆ¶
- **é™é¢‘ä¿æŠ¤**: ccxt åˆ†é¡µéµå®ˆ Bitget é™åˆ¶

### æ€§èƒ½
- **çº¿ç¨‹æ± éš”ç¦»**: å›æµ‹ä»»åŠ¡åœ¨çº¿ç¨‹æ± ä¸­è¿è¡Œï¼Œé¿å…é˜»å¡äº‹ä»¶å¾ªç¯
- **æ•°æ®åº“ç´¢å¼•**: session_id + ts ç´¢å¼•ï¼Œå¿«é€Ÿå›¾è¡¨åˆ†é¡µ
- **Canvas æ¸²æŸ“**: KLineChart ä½¿ç”¨ Canvas æ¨¡å¼ï¼Œæ”¯æŒä¸‡çº§ K çº¿
- **è™šæ‹Ÿæ»šåŠ¨**: äº¤æ˜“è®°å½•è¡¨æ ¼ä½¿ç”¨ `react-window`
- **æ•°æ®èŠ‚æµ**: WebSocket ä½¿ç”¨ `requestAnimationFrame` ç¼“å†²æ›´æ–°

---

## ğŸ“¦ ä¾èµ–å®‰è£…

### åç«¯
```bash
# æ— éœ€æ–°å¢ä¾èµ–ï¼Œå¤ç”¨ç°æœ‰ ccxt, pandas, fastapi, sqlite3
```

### å‰ç«¯
```bash
cd apps/dashboard
npm install klinecharts react-resizable-panels react-window zustand
```

---

## âœ… éªŒæ”¶æ ‡å‡†

1. âœ… ç”¨æˆ·å¯ä»¥é…ç½®å›æµ‹å‚æ•°å¹¶å¯åŠ¨å›æµ‹
2. âœ… å®æ—¶æ˜¾ç¤ºå›æµ‹è¿›åº¦å’Œäº¤æ˜“äº‹ä»¶
3. âœ… Kçº¿å›¾æ­£ç¡®å±•ç¤ºä¹°å–ç‚¹æ ‡è®°
4. âœ… å›¾è¡¨ä¸è¡¨æ ¼åŒå‘è”åŠ¨
5. âœ… å›æµ‹ç»“æœç»Ÿè®¡å‡†ç¡®ï¼ˆæ”¶ç›Šç‡ã€èƒœç‡ã€å¤æ™®æ¯”ç‡ç­‰ï¼‰
6. âœ… æ”¯æŒå¯¼å‡ºå›æµ‹æŠ¥å‘Šï¼ˆCSV/Excelï¼‰
7. âœ… ç®¡ç†å‘˜å¯ä»¥å°†å›æµ‹ç­–ç•¥åº”ç”¨åˆ°å®ç›˜
8. âœ… æ‰€æœ‰æ“ä½œæœ‰å®¡è®¡æ—¥å¿—

---

## ğŸš€ åç»­æ‰©å±•

1. **å¤šç­–ç•¥å¯¹æ¯”**: æ”¯æŒåŒæ—¶è¿è¡Œå¤šä¸ªç­–ç•¥å¹¶å¯¹æ¯”ç»“æœ
2. **å‚æ•°ä¼˜åŒ–**: æ”¯æŒç½‘æ ¼æœç´¢æœ€ä¼˜å‚æ•°
3. **å®æ—¶å›æµ‹**: æ”¯æŒå®æ—¶æ•°æ®æµå›æµ‹
4. **PDF æŠ¥å‘Š**: ç”Ÿæˆä¸“ä¸šçš„ PDF å›æµ‹æŠ¥å‘Š
5. **ç­–ç•¥å¸‚åœº**: æ”¯æŒå¯¼å…¥/å¯¼å‡ºç­–ç•¥é…ç½®

---

**Shall I proceed with this plan? (Y/N)**
