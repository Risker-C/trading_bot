## 模块 B：WebSocket 增强（10 任务点）

### B.1 订阅机制（3 任务点）

**文件**: `apps/api/websocket.py`

- [ ] **任务 B.1.1**：实现频道订阅管理（2 点）
  - **输入**：客户端订阅消息
  - **输出**：订阅确认和数据推送
  - **关键步骤**：
    1. 修改 `ConnectionManager` 类，添加订阅管理
    2. 为每个连接维护订阅频道列表
    3. 实现 `subscribe(channels: List[str])` 方法
    4. 实现 `unsubscribe(channels: List[str])` 方法
    5. 只推送已订阅频道的数据
  - **验收标准**：
    - 客户端可以选择订阅特定频道
    - 只推送已订阅频道的数据
    - 支持动态订阅/取消订阅

- [ ] **任务 B.1.2**：定义订阅消息协议（1 点）
  - **输入**：WebSocket 消息
  - **输出**：标准化的订阅协议
  - **关键步骤**：
    1. 定义订阅消息格式（action: subscribe/unsubscribe）
    2. 定义可用频道列表（trades, positions, trends, indicators）
    3. 添加订阅确认消息
    4. 添加错误处理（无效频道）
  - **验收标准**：
    - 订阅消息格式清晰
    - 支持批量订阅
    - 错误消息明确

---

### B.2 心跳检测（2 任务点）

**文件**: `apps/api/websocket.py`

- [ ] **任务 B.2.1**：实现服务端心跳（1 点）
  - **输入**：WebSocket 连接
  - **输出**：定期 ping 消息
  - **关键步骤**：
    1. 在 WebSocket 循环中添加心跳逻辑
    2. 每 30 秒发送 ping 消息
    3. 等待客户端 pong 响应
    4. 超时未响应则断开连接
  - **验收标准**：
    - 定期发送 ping 消息
    - 检测客户端响应
    - 自动清理死连接

- [ ] **任务 B.2.2**：实现客户端心跳响应（1 点）
  - **输入**：服务端 ping 消息
  - **输出**：pong 响应
  - **关键步骤**：
    1. 处理客户端发送的 pong 消息
    2. 更新连接最后活跃时间
    3. 记录心跳日志
  - **验收标准**：
    - 正确处理 pong 消息
    - 更新连接状态
    - 日志记录完整

---

### B.3 频道管理（3 任务点）

**文件**: `apps/api/websocket.py`

- [ ] **任务 B.3.1**：实现频道数据隔离（2 点）
  - **输入**：订阅频道列表
  - **输出**：按频道推送数据
  - **关键步骤**：
    1. 修改 `_build_payload()` 方法，接受频道参数
    2. 根据订阅频道选择性查询数据
    3. 只返回订阅频道的数据
    4. 优化查询性能（避免查询未订阅的数据）
  - **验收标准**：
    - 只推送订阅频道的数据
    - 减少不必要的数据库查询
    - 性能提升明显

- [ ] **任务 B.3.2**：添加频道配置（1 点）
  - **输入**：环境变量配置
  - **输出**：频道配置管理
  - **关键步骤**：
    1. 定义可用频道列表
    2. 配置每个频道的推送间隔
    3. 配置每个频道的数据限制
    4. 添加频道权限控制（可选）
  - **验收标准**：
    - 频道配置清晰
    - 支持动态配置
    - 配置文档完整

---

### B.4 错误重连（2 任务点）

**文件**: `apps/api/websocket.py`

- [ ] **任务 B.4.1**：实现服务端重连逻辑（1 点）
  - **输入**：连接异常
  - **输出**：错误信息和重连建议
  - **关键步骤**：
    1. 捕获 WebSocket 异常
    2. 返回明确的错误码和消息
    3. 建议客户端重连策略
    4. 记录错误日志
  - **验收标准**：
    - 异常处理完善
    - 错误消息清晰
    - 日志记录详细

- [ ] **任务 B.4.2**：添加连接状态管理（1 点）
  - **输入**：连接事件
  - **输出**：连接状态跟踪
  - **关键步骤**：
    1. 记录连接建立时间
    2. 记录连接断开原因
    3. 统计连接时长
    4. 监控连接健康度
  - **验收标准**：
    - 连接状态可追踪
    - 统计数据准确
    - 支持监控告警

---

## 模块 C：数据库优化（8 任务点）

### C.1 WAL 模式启用（2 任务点）

**文件**: `apps/api/database.py`

- [ ] **任务 C.1.1**：统一启用 WAL 模式（1 点）
  - **输入**：数据库连接
  - **输出**：WAL 模式配置
  - **关键步骤**：
    1. 创建 `apps/api/database.py` 数据库工具模块
    2. 实现 `enable_wal_mode()` 函数
    3. 在所有 Service 初始化时调用
    4. 配置 `PRAGMA synchronous=NORMAL`
    5. 配置 `PRAGMA busy_timeout=5000`
  - **验收标准**：
    - WAL 模式成功启用
    - 并发读写性能提升
    - 无数据库锁定错误

- [ ] **任务 C.1.2**：添加数据库连接池（1 点）
  - **输入**：数据库配置
  - **输出**：连接池管理
  - **关键步骤**：
    1. 使用 `aiosqlite` 替代 `sqlite3`（可选）
    2. 实现连接池管理
    3. 配置最大连接数
    4. 添加连接超时处理
  - **验收标准**：
    - 连接复用率提升
    - 并发性能优化
    - 资源占用合理

---

### C.2 索引优化（3 任务点）

**文件**: `apps/api/database.py`

- [ ] **任务 C.2.1**：创建必要索引（2 点）
  - **输入**：数据库表结构
  - **输出**：索引创建脚本
  - **关键步骤**：
    1. 创建 `apps/api/migrations/001_add_indexes.sql`
    2. 为 `trades.created_at` 创建索引
    3. 为 `trades.strategy` 创建索引
    4. 为 `trades.symbol` 创建索引
    5. 为 `trade_tags.timestamp` 创建索引
    6. 为 `position_snapshots.created_at` 创建索引
    7. 创建复合索引 `(symbol, created_at)`
  - **验收标准**：
    - 所有索引创建成功
    - 查询性能显著提升
    - 索引大小合理

- [ ] **任务 C.2.2**：实现索引管理工具（1 点）
  - **输入**：数据库连接
  - **输出**：索引管理函数
  - **关键步骤**：
    1. 在 `database.py` 中添加 `create_indexes()` 函数
    2. 检查索引是否存在
    3. 自动创建缺失的索引
    4. 记录索引创建日志
  - **验收标准**：
    - 索引自动创建
    - 幂等性保证
    - 日志记录完整

---

### C.3 查询优化（3 任务点）

**文件**: `apps/api/services/*.py`

- [ ] **任务 C.3.1**：优化交易查询（1 点）
  - **输入**：查询参数
  - **输出**：优化后的 SQL
  - **关键步骤**：
    1. 使用索引字段进行筛选
    2. 避免 SELECT *，只查询需要的字段
    3. 使用 LIMIT 和 OFFSET 分页
    4. 添加查询缓存（可选）
  - **验收标准**：
    - 查询时间 < 100ms
    - 使用 EXPLAIN 验证索引使用
    - 内存占用合理

- [ ] **任务 C.3.2**：优化统计查询（1 点）
  - **输入**：统计参数
  - **输出**：优化后的聚合查询
  - **关键步骤**：
    1. 使用聚合函数（SUM, AVG, COUNT）
    2. 添加时间范围索引
    3. 使用子查询优化复杂统计
    4. 考虑使用物化视图（可选）
  - **验收标准**：
    - 统计查询时间 < 200ms
    - 结果准确
    - 支持大数据量

- [ ] **任务 C.3.3**：添加查询性能监控（1 点）
  - **输入**：查询执行
  - **输出**：性能日志
  - **关键步骤**：
    1. 记录慢查询（> 200ms）
    2. 统计查询频率
    3. 监控数据库连接数
    4. 添加性能告警
  - **验收标准**：
    - 慢查询可追踪
    - 性能数据可视化
    - 告警及时

---

## 模块 D：错误处理（8 任务点）

### D.1 错误码定义（2 任务点）

**文件**: `apps/api/errors.py`

- [ ] **任务 D.1.1**：创建错误码枚举（1 点）
  - **输入**：业务错误场景
  - **输出**：错误码定义
  - **关键步骤**：
    1. 创建 `apps/api/errors.py`
    2. 定义 `ErrorCode` 枚举类
    3. 包含认证错误（INVALID_TOKEN, TOKEN_EXPIRED）
    4. 包含业务错误（TRADE_NOT_FOUND, INVALID_PARAMETER）
    5. 包含系统错误（DATABASE_ERROR, INTERNAL_ERROR）
    6. 包含限流错误（RATE_LIMIT_EXCEEDED）
  - **验收标准**：
    - 错误码覆盖所有场景
    - 错误码命名清晰
    - 包含错误描述

- [ ] **任务 D.1.2**：创建自定义异常类（1 点）
  - **输入**：错误码和错误信息
  - **输出**：异常类层次结构
  - **关键步骤**：
    1. 创建基础异常类 `APIException`
    2. 创建认证异常 `AuthenticationException`
    3. 创建业务异常 `BusinessException`
    4. 创建验证异常 `ValidationException`
    5. 每个异常包含错误码、消息、详情
  - **验收标准**：
    - 异常层次清晰
    - 支持错误详情
    - 易于使用

---

### D.2 统一错误响应（3 任务点）

**文件**: `apps/api/middleware.py`

- [ ] **任务 D.2.1**：实现全局异常处理器（2 点）
  - **输入**：异常对象
  - **输出**：标准化错误响应
  - **关键步骤**：
    1. 创建 `apps/api/middleware.py`
    2. 实现 `exception_handler()` 函数
    3. 捕获所有自定义异常
    4. 返回统一的错误响应格式
    5. 记录错误日志
    6. 在 `main.py` 中注册异常处理器
  - **验收标准**：
    - 所有异常统一处理
    - 错误响应格式一致
    - 日志记录完整

- [ ] **任务 D.2.2**：定义错误响应模型（1 点）
  - **输入**：错误信息
  - **输出**：`ErrorResponse` 模型
  - **关键步骤**：
    1. 在 `models/error.py` 中创建错误响应模型
    2. 包含 code, message, details, timestamp 字段
    3. 支持嵌套错误详情
    4. 添加到 OpenAPI 文档
  - **验收标准**：
    - 响应格式标准化
    - 包含必要的错误信息
    - 文档清晰

---

### D.3 请求限流（3 任务点）

**文件**: `apps/api/middleware.py`

- [ ] **任务 D.3.1**：实现基于 IP 的限流（2 点）
  - **输入**：请求 IP 地址
  - **输出**：限流判断
  - **关键步骤**：
    1. 使用 `slowapi` 库实现限流
    2. 配置全局限流规则（100 req/min）
    3. 配置敏感接口限流（10 req/min）
    4. 使用内存存储（开发）或 Redis（生产）
    5. 返回 429 错误和 Retry-After 头
  - **验收标准**：
    - 限流规则生效
    - 超限返回 429 错误
    - 包含重试时间提示

- [ ] **任务 D.3.2**：添加限流配置（1 点）
  - **输入**：环境变量
  - **输出**：限流配置
  - **关键步骤**：
    1. 在 `.env` 中添加限流配置
    2. 配置全局限流阈值
    3. 配置白名单 IP
    4. 配置限流存储方式
  - **验收标准**：
    - 配置灵活可调
    - 支持白名单
    - 文档完整

---
