# 页面闪烁修复实施计划

## 问题描述
前端页面打开后出现闪烁，疑似数据刷新两次。

## 根因分析
1. **本地状态初始化延迟**：每个页面 `hasToken` 默认为 `false`，`useEffect` 异步检查后触发重渲染
2. **React 18 StrictMode 双执行**：开发模式下副作用执行两次
3. **WebSocket 重复连接**：DashboardLayout 和各页面独立调用，每次导航建立 2+ 个连接
4. **缺少占位策略**：无骨架屏，空态到数据态跳变明显

## 解决方案
**方案 A**：全局 AuthProvider + 同步初始化 + WebSocket 单例

## 文件变更清单

### 新增文件（4个）
1. `apps/dashboard/context/AuthContext.tsx` - 全局认证状态管理
2. `apps/dashboard/context/WebSocketContext.tsx` - 单例 WebSocket 连接
3. `apps/dashboard/hooks/useAuth.ts` - 便捷访问 Hook
4. `apps/dashboard/components/FullPageLoader.tsx` - 初始化加载界面

### 修改文件（7个）
1. `apps/dashboard/app/providers.tsx` - 注册新 Provider
2. `apps/dashboard/app/page.tsx` - 删除本地认证逻辑
3. `apps/dashboard/app/analytics/page.tsx` - 删除本地认证逻辑
4. `apps/dashboard/app/trades/page.tsx` - 删除本地认证逻辑
5. `apps/dashboard/app/monitor/page.tsx` - 添加认证检查
6. `apps/dashboard/components/DashboardLayout.tsx` - 移除独立 WebSocket
7. `apps/dashboard/hooks/useWebSocket.ts` - 改为消费 Context

## 实施步骤

### Phase 1：基础设施建设（P0）
- 创建 AuthContext.tsx
- 创建 WebSocketContext.tsx
- 创建 FullPageLoader.tsx
- 更新 providers.tsx

### Phase 2：页面逻辑清理（P1）
- 重构 4 个页面（page, analytics, trades, monitor）
- 添加骨架屏（可选）

### Phase 3：WebSocket 优化（P2）
- 重构 DashboardLayout.tsx
- 重构 hooks/useWebSocket.ts

## 预期效果
- 页面渲染次数：2-3次 → 1次（⬇️ 66%）
- API 请求次数：2次 → 1次（⬇️ 50%）
- WebSocket 连接数：2+个 → 1个（⬇️ 50%+）
- 首屏闪烁：明显 → 无（✅ 消除）

## 批准信息
- 批准时间：2026-01-15
- 批准方案：方案 A（全局 AuthProvider + 同步初始化）
- 实施模型：Codex（后端逻辑）+ Gemini（前端架构）+ Claude（编排实施）
