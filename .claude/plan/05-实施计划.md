# 交易数据可视化项目 - 实施计划

**文档版本**: v1.0
**创建时间**: 2026-01-09

---

## 1. 实施概览

### 1.1 总体时间规划

| 阶段 | 任务 | 预计工作量 |
|------|------|-----------|
| **阶段0** | 环境准备 | 0.5天 |
| **阶段1** | 后端API开发 | 2-3天 |
| **阶段2** | 前端Dashboard开发 | 3-4天 |
| **阶段3** | 集成测试 | 1天 |
| **阶段4** | 部署上线 | 0.5天 |

**总计**: 7-9天

---

## 2. 阶段0：环境准备

### 2.1 创建项目结构

```bash
# 在 trading_bot 根目录下
mkdir -p apps/api apps/dashboard
```

### 2.2 初始化后端项目

```bash
cd apps/api

# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 创建 requirements.txt
cat > requirements.txt << EOF
fastapi==0.109.0
uvicorn[standard]==0.27.0
python-jose[cryptography]==3.3.0
passlib[bcrypt]==1.7.4
python-multipart==0.0.6
websockets==12.0
pydantic==2.5.0
pydantic-settings==2.1.0
EOF

# 安装依赖
pip install -r requirements.txt
```

### 2.3 初始化前端项目

```bash
cd apps/dashboard

# 使用 create-next-app
npx create-next-app@latest . --typescript --tailwind --app --no-src-dir

# 安装 shadcn/ui
npx shadcn-ui@latest init

# 安装其他依赖
npm install @tanstack/react-query zustand recharts axios
npm install -D @types/node
```

### 2.4 配置环境变量

**后端 `.env`**:
```bash
# apps/api/.env
DATABASE_PATH=../../trading_bot.db
JWT_SECRET=your-secret-key-change-this
JWT_ALGORITHM=HS256
JWT_EXPIRE_MINUTES=1440
CLAUDE_API_KEY=your-claude-api-key
CORS_ORIGINS=http://localhost:3000,https://your-dashboard.vercel.app
```

**前端 `.env.local`**:
```bash
# apps/dashboard/.env.local
NEXT_PUBLIC_API_URL=http://localhost:8000
NEXT_PUBLIC_WS_URL=ws://localhost:8000
```

---

## 3. 阶段1：后端API开发

### 3.1 任务清单

- [ ] 创建基础项目结构
- [ ] 实现认证模块
- [ ] 实现交易数据接口
- [ ] 实现持仓接口
- [ ] 实现趋势接口
- [ ] 实现指标接口
- [ ] 实现历史记录接口
- [ ] 实现AI交互接口
- [ ] 实现WebSocket推送
- [ ] 添加单元测试

### 3.2 核心文件创建

**1. 主入口文件** (`main.py`):
```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
import os
from dotenv import load_dotenv

load_dotenv()

app = FastAPI(
    title="Trading Dashboard API",
    version="1.0.0",
    description="API for trading data visualization"
)

# CORS配置
app.add_middleware(
    CORSMiddleware,
    allow_origins=os.getenv("CORS_ORIGINS", "").split(","),
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.get("/")
async def root():
    return {"message": "Trading Dashboard API"}

@app.get("/health")
async def health():
    return {"status": "healthy"}
```

**2. 认证模块** (`auth.py`):
```python
from datetime import datetime, timedelta
from jose import JWTError, jwt
from passlib.context import CryptContext
from fastapi import Depends, HTTPException, status
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
import os

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
security = HTTPBearer()

SECRET_KEY = os.getenv("JWT_SECRET")
ALGORITHM = os.getenv("JWT_ALGORITHM", "HS256")

def create_access_token(data: dict):
    to_encode = data.copy()
    expire = datetime.utcnow() + timedelta(minutes=int(os.getenv("JWT_EXPIRE_MINUTES", 1440)))
    to_encode.update({"exp": expire})
    return jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)

async def get_current_user(credentials: HTTPAuthorizationCredentials = Depends(security)):
    try:
        token = credentials.credentials
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        return payload
    except JWTError:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid authentication credentials"
        )
```

**3. 数据库服务** (`services/trade_service.py`):
```python
import sys
import os
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '../../../'))

from logger_utils import TradeDatabase

class TradeService:
    def __init__(self):
        db_path = os.getenv("DATABASE_PATH", "../../trading_bot.db")
        self.db = TradeDatabase(db_path)

    async def get_trades(self, limit: int = 50, offset: int = 0, strategy: str = None):
        trades = self.db.get_trades(limit=limit, offset=offset)
        # 筛选策略
        if strategy:
            trades = [t for t in trades if t.get('strategy') == strategy]
        return {
            "total": len(trades),
            "data": trades
        }
```

### 3.3 测试命令

```bash
# 启动开发服务器
cd apps/api
uvicorn main:app --reload --port 8000

# 测试API
curl http://localhost:8000/health
```

---

## 4. 阶段2：前端Dashboard开发

### 4.1 任务清单

- [ ] 配置shadcn/ui组件
- [ ] 创建布局组件
- [ ] 实现登录页面
- [ ] 实现指标卡片
- [ ] 实现趋势图表
- [ ] 实现指标面板
- [ ] 实现历史记录表格
- [ ] 实现AI聊天组件
- [ ] 实现WebSocket连接
- [ ] 添加响应式设计

### 4.2 安装shadcn/ui组件

```bash
cd apps/dashboard

# 安装需要的组件
npx shadcn-ui@latest add card
npx shadcn-ui@latest add button
npx shadcn-ui@latest add table
npx shadcn-ui@latest add badge
npx shadcn-ui@latest add input
npx shadcn-ui@latest add select
npx shadcn-ui@latest add sheet
npx shadcn-ui@latest add scroll-area
npx shadcn-ui@latest add skeleton
```

### 4.3 核心组件创建

**1. API客户端** (`lib/api-client.ts`):
```typescript
import axios from 'axios';

const apiClient = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_URL,
  timeout: 10000,
});

apiClient.interceptors.request.use((config) => {
  const token = localStorage.getItem('access_token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

export default apiClient;
```

**2. 主页面** (`app/page.tsx`):
```typescript
'use client';

import { useQuery } from '@tanstack/react-query';
import apiClient from '@/lib/api-client';
import MetricCard from '@/components/MetricCard';
import TrendChart from '@/components/TrendChart';

export default function DashboardPage() {
  const { data: position } = useQuery({
    queryKey: ['position'],
    queryFn: async () => {
      const { data } = await apiClient.get('/api/positions/current');
      return data;
    },
    refetchInterval: 5000,
  });

  return (
    <div className="p-6 space-y-6">
      <div className="grid grid-cols-4 gap-4">
        <MetricCard title="余额" value={position?.account?.balance} />
        {/* 其他指标卡片 */}
      </div>

      <div className="grid grid-cols-2 gap-4">
        <TrendChart />
        {/* 指标面板 */}
      </div>

      {/* 历史记录表格 */}
    </div>
  );
}
```

### 4.4 测试命令

```bash
# 启动开发服务器
cd apps/dashboard
npm run dev

# 访问 http://localhost:3000
```

---

## 5. 阶段3：集成测试

### 5.1 测试清单

- [ ] 登录功能测试
- [ ] API接口测试
- [ ] WebSocket连接测试
- [ ] 数据刷新测试
- [ ] 错误处理测试
- [ ] 响应式布局测试
- [ ] 性能测试

### 5.2 测试场景

**场景1：用户登录**
1. 访问登录页面
2. 输入用户名密码
3. 验证Token存储
4. 跳转到Dashboard

**场景2：实时数据更新**
1. 建立WebSocket连接
2. 模拟交易数据变化
3. 验证UI自动更新
4. 验证断线重连

**场景3：历史记录查询**
1. 打开历史记录页面
2. 应用筛选条件
3. 验证分页功能
4. 验证数据导出

---

## 6. 阶段4：部署上线

### 6.1 后端部署

**本地部署**:
```bash
# 使用systemd管理服务
sudo nano /etc/systemd/system/trading-api.service

[Unit]
Description=Trading Dashboard API
After=network.target

[Service]
Type=simple
User=your-user
WorkingDirectory=/path/to/trading_bot/apps/api
Environment="PATH=/path/to/venv/bin"
ExecStart=/path/to/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000
Restart=always

[Install]
WantedBy=multi-user.target

# 启动服务
sudo systemctl start trading-api
sudo systemctl enable trading-api
```

**使用ngrok暴露API**:
```bash
ngrok http 8000
# 获得公网URL: https://xxx.ngrok.io
```

### 6.2 前端部署到Vercel

```bash
cd apps/dashboard

# 安装Vercel CLI
npm i -g vercel

# 登录
vercel login

# 部署
vercel --prod

# 配置环境变量
vercel env add NEXT_PUBLIC_API_URL
# 输入: https://xxx.ngrok.io (或你的API域名)
```

### 6.3 部署检查清单

- [ ] 后端API正常运行
- [ ] 前端成功部署到Vercel
- [ ] 环境变量配置正确
- [ ] CORS配置正确
- [ ] WebSocket连接正常
- [ ] HTTPS证书有效
- [ ] 性能监控配置

---

## 7. 后续优化

### 7.1 短期优化（1-2周）

- [ ] 添加更多图表类型
- [ ] 优化移动端体验
- [ ] 添加数据导出功能
- [ ] 实现用户偏好设置
- [ ] 添加通知功能

### 7.2 中期优化（1-2月）

- [ ] 添加多用户支持
- [ ] 实现权限管理
- [ ] 添加更多AI功能
- [ ] 优化数据库查询性能
- [ ] 添加缓存层（Redis）

### 7.3 长期规划（3-6月）

- [ ] 迁移到Postgres
- [ ] 实现微服务架构
- [ ] 添加移动端App
- [ ] 实现多交易所支持
- [ ] 添加社区功能

---

## 8. 风险应对

### 8.1 技术风险

| 风险 | 应对措施 |
|------|---------|
| SQLite并发问题 | 启用WAL模式，添加重试逻辑 |
| API性能瓶颈 | 添加缓存，优化查询 |
| WebSocket不稳定 | 实现自动重连，降级到轮询 |
| 部署失败 | 准备回滚方案，保留旧版本 |

### 8.2 业务风险

| 风险 | 应对措施 |
|------|---------|
| 影响交易系统 | 只读访问，独立进程 |
| 数据泄露 | 强化认证，HTTPS加密 |
| 成本超支 | 监控API调用，设置限额 |

---

## 9. 成功标准

### 9.1 功能完整性

- ✅ 6个核心功能全部实现
- ✅ 所有API端点正常工作
- ✅ WebSocket实时推送正常
- ✅ 前端UI完整无缺陷

### 9.2 性能指标

- ✅ API响应时间 < 500ms (P95)
- ✅ 页面加载时间 < 3s
- ✅ WebSocket延迟 < 1s
- ✅ 无明显内存泄漏

### 9.3 用户体验

- ✅ UI美观，符合现代设计
- ✅ 响应式设计，支持移动端
- ✅ 错误提示清晰
- ✅ 操作流畅，无卡顿

---

**下一步**: 阅读 `06-TodoList.md` 查看详细任务清单。
