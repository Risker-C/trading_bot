# 市场数据查看功能 - 详细实施计划

> 创建时间: 2026-01-13
> 方案: C (先诊断再开发)
> Workflow Phase: 3 - 详细规划

## 背景

**问题**: 交易机器人运行9小时无成交
**原因**: 市场状态"ranging" + ADX≈39.3 + 6个趋势策略启用
**目标**: 查看市场数据诊断问题，并建立持续监控能力

---

## 阶段1: 立即诊断 (方案1)

### 1.1 运行现有诊断脚本

#### 任务1.1.1: 运行指标诊断
```bash
python diagnose_indicators.py
```

**预期输出**:
- 当前价格与24h变化
- RSI、MACD、EMA、ADX、布林带、KDJ指标值
- 各指标的解读（超买/超卖/趋势强度）

**关键检查点**:
- [ ] ADX值是否真的≈39.3
- [ ] 布林带宽度百分比
- [ ] 市场状态判定逻辑是否一致

#### 任务1.1.2: 运行信号诊断
```bash
python diagnose_signals.py
```

**预期输出**:
- 当前市场状态（regime）
- 各策略的信号生成情况
- 共识过滤结果
- 为什么没有产生交易信号

**关键检查点**:
- [ ] 动态策略选择是否过滤了趋势策略
- [ ] 共识条件是否过严
- [ ] MIN_SIGNAL_STRENGTH/CONFIDENCE阈值

#### 任务1.1.3: 检查配置参数
```bash
# 查看关键配置
grep -E "(USE_DYNAMIC_STRATEGY|USE_CONSENSUS_SIGNAL|MIN_SIGNAL)" config.py
grep -E "(MIN_SIGNAL_STRENGTH|MIN_SIGNAL_CONFIDENCE)" config/strategies.py
```

**关键检查点**:
- [ ] USE_DYNAMIC_STRATEGY 是否启用
- [ ] USE_CONSENSUS_SIGNAL 是否启用
- [ ] 信号强度/置信度阈值是否合理

### 1.2 诊断结果分析

**输出文档**: `logs/diagnosis_2026-01-13.txt`

**分析维度**:
1. 市场状态矛盾性（ADX vs ranging）
2. 策略过滤链路（动态选择 → 信号生成 → 共识过滤）
3. 参数合理性评估

---

## 阶段2: 开发结构化监控工具 (方案2)

### 2.1 需求定义

#### 功能需求
- 获取多时间周期市场数据（5m/15m/1h/4h）
- 计算所有技术指标
- 检测市场状态
- 分析策略信号
- 输出JSON格式

#### 非功能需求
- 响应时间 < 3秒
- 支持缓存（避免频繁API调用）
- 错误处理与降级

### 2.2 技术设计

#### 2.2.1 文件结构
```
/root/trading_bot/
├── market_snapshot.py          # 新增：市场快照主脚本
├── cli.py                      # 修改：添加market子命令
└── utils/
    └── market_formatter.py     # 新增：格式化输出工具
```

#### 2.2.2 核心模块设计

**market_snapshot.py**
```python
class MarketSnapshot:
    """市场快照生成器"""

    def __init__(self, trader, timeframes=['5m', '15m', '1h', '4h']):
        self.trader = trader
        self.timeframes = timeframes

    async def fetch_snapshot(self) -> dict:
        """异步获取市场快照"""
        # 1. 并发获取多时间周期数据
        # 2. 计算各周期指标
        # 3. 检测市场状态
        # 4. 分析策略信号
        # 5. 返回结构化数据

    def to_json(self, snapshot: dict) -> str:
        """输出JSON格式"""

    def to_dashboard(self, snapshot: dict) -> str:
        """输出Dashboard格式（ANSI彩色）"""
```

**utils/market_formatter.py**
```python
class MarketFormatter:
    """市场数据格式化工具"""

    @staticmethod
    def format_dashboard(data: dict) -> str:
        """全景看板格式"""
        # 使用ANSI颜色高亮
        # 分级信息架构

    @staticmethod
    def format_decision_trace(data: dict) -> str:
        """决策溯源格式"""
        # 管道流展示
```

#### 2.2.3 JSON输出规范
```json
{
  "timestamp": "2026-01-13T10:00:00Z",
  "symbol": "BTC/USDT:USDT",
  "timeframes": {
    "15m": {
      "price": {
        "current": 95000.0,
        "change_24h": 2.5
      },
      "indicators": {
        "adx": 39.3,
        "plus_di": 25.0,
        "minus_di": 15.0,
        "rsi": 55.0,
        "macd": {...},
        "bollinger": {
          "upper": 96000,
          "middle": 95000,
          "lower": 94000,
          "width_pct": 2.1
        }
      },
      "market_regime": {
        "state": "ranging",
        "confidence": 0.7,
        "details": {...}
      },
      "strategy_signals": [
        {
          "name": "adx_trend",
          "signal": "hold",
          "strength": 0.3,
          "reason": "ADX rising but no DI crossover"
        }
      ]
    }
  },
  "consensus": {
    "enabled": true,
    "result": "no_signal",
    "reason": "Insufficient signal strength"
  }
}
```

### 2.3 实施步骤

#### Step 1: 创建market_snapshot.py
- [ ] 实现MarketSnapshot类
- [ ] 集成trader.fetch_multi_timeframe_data()
- [ ] 集成IndicatorCalculator
- [ ] 集成MarketRegimeDetector
- [ ] 集成策略分析逻辑

#### Step 2: 创建market_formatter.py
- [ ] 实现Dashboard格式化
- [ ] 实现Decision Trace格式化
- [ ] ANSI颜色高亮逻辑

#### Step 3: 集成到CLI
- [ ] 修改cli.py添加market子命令
- [ ] 支持参数：--format (json/dashboard/trace)
- [ ] 支持参数：--timeframes (指定周期)

#### Step 4: 测试
- [ ] 单元测试：market_snapshot.py
- [ ] 集成测试：完整数据流
- [ ] 性能测试：响应时间
- [ ] 边界测试：API失败降级

### 2.4 使用示例

```bash
# JSON输出
python cli.py market --format json > market_snapshot.json

# Dashboard输出
python cli.py market --format dashboard

# 指定时间周期
python cli.py market --timeframes 15m,1h --format dashboard

# 决策溯源
python cli.py market --format trace
```

---

## 时间估算

| 阶段 | 任务 | 预计时间 |
|------|------|----------|
| 阶段1 | 运行诊断脚本 | 10分钟 |
| 阶段1 | 分析结果 | 20分钟 |
| 阶段2 | 创建market_snapshot.py | 1小时 |
| 阶段2 | 创建market_formatter.py | 45分钟 |
| 阶段2 | 集成到CLI | 30分钟 |
| 阶段2 | 测试与调试 | 45分钟 |
| **总计** | | **约3.5小时** |

---

## 风险与缓解

### 风险1: API限频
- **影响**: 多时间周期并发请求可能触发限频
- **缓解**: 实现请求缓存，5分钟内复用数据

### 风险2: 数据不一致
- **影响**: 不同周期数据时间戳不对齐
- **缓解**: 记录每个周期的实际时间戳

### 风险3: 指标计算错误
- **影响**: 输出数据不准确
- **缓解**: 对比现有diagnose脚本输出验证

---

## 验收标准

### 阶段1验收
- [x] 成功运行diagnose_indicators.py
- [x] 成功运行diagnose_signals.py
- [x] 识别出"无成交"的根本原因
- [x] 输出诊断报告文档

### 阶段2验收
- [ ] market_snapshot.py能正常运行
- [ ] JSON输出符合规范
- [ ] Dashboard输出清晰易读
- [ ] 响应时间 < 3秒
- [ ] 通过所有测试用例
- [ ] 集成到cli.py可正常调用

---

## 后续优化方向

1. **缓存优化**: Redis缓存市场数据
2. **告警集成**: 异常市场状态推送飞书
3. **历史记录**: 定期保存快照到数据库
4. **Web Dashboard**: 实施方案3（长期）

---

**计划状态**: ✅ 已完成
**下一步**: 进入 Phase 4 - 执行实施
