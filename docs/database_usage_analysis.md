# æ•°æ®åº“è¡¨ä½¿ç”¨æƒ…å†µåˆ†ææŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: 2026-01-30
**æ•°æ®åº“**: trading_bot.db (ç”Ÿäº§ç¯å¢ƒ)
**åˆ†æèŒƒå›´**: 8ä¸ªæ ¸å¿ƒè¡¨çš„ä½¿ç”¨æƒ…å†µ

---

## ğŸ“Š æ•°æ®æ¦‚è§ˆ

| è¡¨å | è®°å½•æ•° | çŠ¶æ€ | ä½¿ç”¨æƒ…å†µ |
|------|--------|------|----------|
| `trades` | 0 | âš ï¸ æœªä½¿ç”¨ | äº¤æ˜“è®°å½•è¡¨ |
| `signals` | 61 | âœ… æ­£å¸¸ä½¿ç”¨ | ç­–ç•¥ä¿¡å·è¡¨ |
| `position_snapshots` | 0 | âš ï¸ æœªä½¿ç”¨ | æŒä»“å¿«ç…§è¡¨ |
| `balance_snapshots` | 11 | âœ… æ­£å¸¸ä½¿ç”¨ | ä½™é¢å¿«ç…§è¡¨ |
| `equity_curve` | 0 | âš ï¸ æœªä½¿ç”¨ | æƒç›Šæ›²çº¿è¡¨ |
| `risk_events` | 0 | âš ï¸ æœªä½¿ç”¨ | é£æ§äº‹ä»¶è¡¨ |
| `daily_stats` | 0 | âš ï¸ æœªä½¿ç”¨ | æ¯æ—¥ç»Ÿè®¡è¡¨ |
| `risk_metrics` | 0 | âš ï¸ æœªä½¿ç”¨ | é£é™©æŒ‡æ ‡è¡¨ |

---

## ğŸ” è¯¦ç»†åˆ†æ

### 1. âœ… æ­£å¸¸ä½¿ç”¨çš„è¡¨

#### `signals` (61æ¡è®°å½•)
**è°ƒç”¨ä½ç½®**:
- `bot.py:1178` - è®°å½•ç­–ç•¥ä¿¡å·ï¼ˆä½¿ç”¨ `log_signal_buffered`ï¼‰
- `bot.py:1249` - è®°å½•ç­–ç•¥ä¿¡å·ï¼ˆä½¿ç”¨ `log_signal_buffered`ï¼‰
- `bot.py:1465` - è®°å½•ç­–ç•¥ä¿¡å·ï¼ˆä½¿ç”¨ `log_signal_buffered`ï¼‰

**ä½¿ç”¨æ–¹å¼**: æ‰¹é‡ç¼“å†²å†™å…¥ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰

**ç»“è®º**: âœ… **æ­£å¸¸ä½¿ç”¨**ï¼Œç­–ç•¥ä¿¡å·æ­£å¸¸è®°å½•

---

#### `balance_snapshots` (11æ¡è®°å½•)
**è°ƒç”¨ä½ç½®**:
- `bot.py:563` - è®°å½•è´¦æˆ·ä½™é¢å¿«ç…§

**ä½¿ç”¨æ–¹å¼**: ç›´æ¥å†™å…¥

**ç»“è®º**: âœ… **æ­£å¸¸ä½¿ç”¨**ï¼Œä½™é¢å¿«ç…§æ­£å¸¸è®°å½•

---

### 2. âš ï¸ æœªä½¿ç”¨çš„è¡¨ï¼ˆä½†ä»£ç å·²å®ç°ï¼‰

#### `trades` (0æ¡è®°å½•)
**åŸå› åˆ†æ**:
1. **ä»£ç å·²å®ç°**: `core/trader.py` ä¸­å·²æ­£ç¡®å®ç°äº¤æ˜“è®°å½•
   - `open_long()` (line 938): è°ƒç”¨ `db.log_trade_buffered()` è®°å½•å¼€ä»“
   - `open_short()` (line 1006): è°ƒç”¨ `db.log_trade_buffered()` è®°å½•å¼€ä»“
   - `close_position()` (line 1159): è°ƒç”¨ `db.log_trade_buffered()` è®°å½•å¹³ä»“
   - `partial_close()` (line 1214): è°ƒç”¨ `db.log_trade_buffered()` è®°å½•éƒ¨åˆ†å¹³ä»“
   - `add_position()` (line 1253): è°ƒç”¨ `db.log_trade_buffered()` è®°å½•åŠ ä»“

2. **ä¸ºä»€ä¹ˆæ²¡æœ‰æ•°æ®**:
   - **Bot æ²¡æœ‰æ‰§è¡Œè¿‡äº¤æ˜“**: å¯èƒ½ä¸€ç›´åœ¨è§‚å¯Ÿæ¨¡å¼ï¼Œæ²¡æœ‰å®é™…å¼€ä»“/å¹³ä»“
   - **æ‰¹é‡ç¼“å†²æœªåˆ·æ–°**: ä½¿ç”¨ `log_trade_buffered()` æ‰¹é‡å†™å…¥ï¼Œç¼“å†²åŒºå¯èƒ½è¿˜æ²¡è¾¾åˆ°åˆ·æ–°æ¡ä»¶
   - **é…ç½®é—®é¢˜**: å¯èƒ½ `DB_BATCH_WRITES_ENABLED = False`ï¼Œå¯¼è‡´ç¼“å†²å†™å…¥è¢«ç¦ç”¨

**ç»“è®º**: âœ… **åŠŸèƒ½æ­£å¸¸ï¼Œä½†æ— äº¤æ˜“æ‰§è¡Œ**

**éªŒè¯æ–¹æ³•**:
```python
# æ£€æŸ¥æ‰¹é‡å†™å…¥é…ç½®
import config
print(f"DB_BATCH_WRITES_ENABLED: {getattr(config, 'DB_BATCH_WRITES_ENABLED', False)}")
print(f"DB_BATCH_SIZE: {getattr(config, 'DB_BATCH_SIZE', 20)}")
```

---

#### `position_snapshots` (0æ¡è®°å½•)
**åŸå› åˆ†æ**:
1. **ä»£ç å·²å®ç°**: `risk/risk_manager.py:1355` è°ƒç”¨ `db.log_position_snapshot()`
2. **è°ƒç”¨æ—¶æœº**:
   - `risk_manager.py:994` - `_save_position_to_db()` åœ¨æŒä»“æ›´æ–°æ—¶è°ƒç”¨
   - `risk_manager.py:1053` - `_save_position_to_db()` åœ¨æŒä»“æ›´æ–°æ—¶è°ƒç”¨
3. **é—®é¢˜**: å¯èƒ½æ˜¯å› ä¸º **æ²¡æœ‰å®é™…æŒä»“**ï¼Œæ‰€ä»¥æ²¡æœ‰å¿«ç…§è®°å½•

**ç»“è®º**: âš ï¸ **åŠŸèƒ½æ­£å¸¸ï¼Œä½†æ— æŒä»“**

**åŸå› **:
- Bot å¯èƒ½ä¸€ç›´åœ¨è§‚å¯Ÿæ¨¡å¼ï¼ˆæ²¡æœ‰å¼€ä»“ï¼‰
- æˆ–è€…æŒä»“æ—¶é—´å¾ˆçŸ­ï¼Œå¿«ç…§æœªè§¦å‘

---

#### `equity_curve` (0æ¡è®°å½•)
**åŸå› åˆ†æ**:
1. **ä»£ç æœç´¢**: åœ¨æ•´ä¸ªé¡¹ç›®ä¸­ **åªæœ‰æµ‹è¯•è„šæœ¬** è°ƒç”¨ `db.log_equity()`
2. **ç”Ÿäº§ä»£ç **: `bot.py` å’Œ `risk_manager.py` ä¸­ **æ²¡æœ‰è°ƒç”¨**

**ç»“è®º**: âš ï¸ **åŠŸèƒ½æœªå®ç°**

**å½±å“**:
- æ— æ³•ç»˜åˆ¶æƒç›Šæ›²çº¿
- æ— æ³•åˆ†æè´¦æˆ·å¢é•¿è¶‹åŠ¿
- æ— æ³•è®¡ç®—æœ€å¤§å›æ’¤

---

#### `risk_events` (0æ¡è®°å½•)
**åŸå› åˆ†æ**:
1. **ä»£ç å·²å®ç°**: `bot.py:1355` è°ƒç”¨ `db.log_risk_event()`
2. **è°ƒç”¨æ—¶æœº**: è§¦å‘æ­¢æŸ/æ­¢ç›ˆæ—¶è®°å½•
3. **é—®é¢˜**: å¯èƒ½æ˜¯å› ä¸º **æ²¡æœ‰è§¦å‘é£æ§äº‹ä»¶**

**ç»“è®º**: âš ï¸ **åŠŸèƒ½æ­£å¸¸ï¼Œä½†æœªè§¦å‘**

**åŸå› **:
- æ²¡æœ‰æŒä»“ï¼Œæ‰€ä»¥æ²¡æœ‰é£æ§äº‹ä»¶
- æˆ–è€…é£æ§å‚æ•°è®¾ç½®å®½æ¾ï¼Œæœªè§¦å‘

---

#### `daily_stats` (0æ¡è®°å½•)
**åŸå› åˆ†æ**:
1. **ä»£ç æœç´¢**: åœ¨æ•´ä¸ªé¡¹ç›®ä¸­ **åªæœ‰æµ‹è¯•è„šæœ¬** è°ƒç”¨ `db.update_daily_stats()`
2. **ç”Ÿäº§ä»£ç **: `bot.py` ä¸­ **æ²¡æœ‰è°ƒç”¨**

**ç»“è®º**: âš ï¸ **åŠŸèƒ½æœªå®ç°**

**å½±å“**:
- æ— æ³•ç”Ÿæˆæ¯æ—¥äº¤æ˜“æŠ¥å‘Š
- æ— æ³•ç»Ÿè®¡æ¯æ—¥ç›ˆäº
- æ— æ³•åˆ†æäº¤æ˜“è¡¨ç°

---

#### `risk_metrics` (0æ¡è®°å½•)
**åŸå› åˆ†æ**:
1. **ä»£ç æœç´¢**: åœ¨æ•´ä¸ªé¡¹ç›®ä¸­ **åªæœ‰æµ‹è¯•è„šæœ¬** è°ƒç”¨ `db.log_risk_metrics()`
2. **ç”Ÿäº§ä»£ç **: `bot.py` å’Œ `risk_manager.py` ä¸­ **æ²¡æœ‰è°ƒç”¨**

**ç»“è®º**: âš ï¸ **åŠŸèƒ½æœªå®ç°**

**å½±å“**:
- æ— æ³•è¿½è¸ªé£é™©æŒ‡æ ‡å˜åŒ–
- æ— æ³•è®¡ç®—èƒœç‡ã€ç›ˆäºæ¯”
- æ— æ³•ä¼˜åŒ– Kelly ç³»æ•°

---

## ğŸ¯ æ ¸å¿ƒé—®é¢˜æ€»ç»“

### é—®é¢˜ 1: `trades` è¡¨ä¸ºç©ºï¼ˆæ­£å¸¸ï¼‰
**åŸå› **: Bot å¯èƒ½æ²¡æœ‰æ‰§è¡Œè¿‡å®é™…äº¤æ˜“ï¼Œæˆ–ä½¿ç”¨æ‰¹é‡ç¼“å†²å†™å…¥ä½†æœªè¾¾åˆ°åˆ·æ–°æ¡ä»¶

**éªŒè¯**:
- âœ… ä»£ç å·²æ­£ç¡®å®ç°ï¼ˆ`open_long`, `open_short`, `close_position` éƒ½æœ‰è°ƒç”¨ï¼‰
- âš ï¸ éœ€è¦æ£€æŸ¥æ˜¯å¦æœ‰å®é™…äº¤æ˜“æ‰§è¡Œ
- âš ï¸ éœ€è¦æ£€æŸ¥æ‰¹é‡å†™å…¥é…ç½®

**ä¼˜å…ˆçº§**: ğŸŸ¢ **ä½ä¼˜å…ˆçº§**ï¼ˆåŠŸèƒ½å·²å®ç°ï¼Œå¯èƒ½æ˜¯æ­£å¸¸ç°è±¡ï¼‰

---

### é—®é¢˜ 2: `position_snapshots` è¡¨ä¸ºç©ºï¼ˆæ­£å¸¸ï¼‰
**åŸå› **: Bot å¯èƒ½æ²¡æœ‰å®é™…æŒä»“ï¼Œæˆ–æŒä»“æ—¶é—´å¾ˆçŸ­

**å½±å“**:
- âš ï¸ æ— æ³•è¿½è¸ªæŒä»“å†å²
- âš ï¸ æ— æ³•åˆ†ææŒä»“è¡¨ç°

**ä¼˜å…ˆçº§**: ğŸŸ¢ **ä½ä¼˜å…ˆçº§**ï¼ˆåŠŸèƒ½å·²å®ç°ï¼Œä½†æœªè§¦å‘ï¼‰

---

### é—®é¢˜ 3: `equity_curve` è¡¨ä¸ºç©ºï¼ˆéœ€è¦å®ç°ï¼‰
**åŸå› **: ç”Ÿäº§ä»£ç ä¸­ **æœªå®ç°æƒç›Šæ›²çº¿è®°å½•åŠŸèƒ½**

**å½±å“**:
- âš ï¸ æ— æ³•ç»˜åˆ¶æƒç›Šæ›²çº¿
- âš ï¸ æ— æ³•åˆ†æè´¦æˆ·å¢é•¿

**ä¼˜å…ˆçº§**: ğŸŸ¡ **ä¸­ä¼˜å…ˆçº§**ï¼ˆåˆ†æåŠŸèƒ½ç¼ºå¤±ï¼‰

---

### é—®é¢˜ 4: `daily_stats` å’Œ `risk_metrics` è¡¨ä¸ºç©ºï¼ˆéœ€è¦å®ç°ï¼‰
**åŸå› **: ç”Ÿäº§ä»£ç ä¸­ **æœªå®ç°ç»Ÿè®¡åŠŸèƒ½**

**å½±å“**:
- â„¹ï¸ æ— æ³•ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š
- â„¹ï¸ æ— æ³•è¿½è¸ªé£é™©æŒ‡æ ‡

**ä¼˜å…ˆçº§**: ğŸŸ¢ **ä½ä¼˜å…ˆçº§**ï¼ˆè¾…åŠ©åŠŸèƒ½ç¼ºå¤±ï¼‰

---

## ğŸ’¡ ä¿®å¤å»ºè®®

### å»ºè®® 1: éªŒè¯äº¤æ˜“è®°å½•åŠŸèƒ½ï¼ˆæ¨èï¼‰

æ£€æŸ¥æ‰¹é‡å†™å…¥é…ç½®å’Œç¼“å†²åŒºçŠ¶æ€ï¼š

```python
# æ£€æŸ¥é…ç½®
import config
print(f"DB_BATCH_WRITES_ENABLED: {getattr(config, 'DB_BATCH_WRITES_ENABLED', False)}")
print(f"DB_BATCH_SIZE: {getattr(config, 'DB_BATCH_SIZE', 20)}")
print(f"DB_BATCH_FLUSH_INTERVAL: {getattr(config, 'DB_BATCH_FLUSH_INTERVAL', 5)}")

# æ‰‹åŠ¨åˆ·æ–°ç¼“å†²åŒº
from utils.logger_utils import db
db.flush_buffers(force=True)

# æ£€æŸ¥æ˜¯å¦æœ‰äº¤æ˜“è®°å½•
trades = db.get_trades(limit=10)
print(f"äº¤æ˜“è®°å½•æ•°: {len(trades)}")
```

**å¦‚æœä»ç„¶æ²¡æœ‰æ•°æ®**ï¼š
- å¯èƒ½æ˜¯ Bot ä¸€ç›´åœ¨è§‚å¯Ÿæ¨¡å¼ï¼Œæ²¡æœ‰å®é™…æ‰§è¡Œäº¤æ˜“
- æ£€æŸ¥ Bot æ—¥å¿—ï¼Œç¡®è®¤æ˜¯å¦æœ‰å¼€ä»“/å¹³ä»“æ“ä½œ

---

### å»ºè®® 2: å®ç°æƒç›Šæ›²çº¿è®°å½•ï¼ˆæ¨èï¼‰

åœ¨ `bot.py` çš„ä¸»å¾ªç¯ä¸­å®šæœŸè®°å½•æƒç›Šï¼š

```python
# bot.py - _main_loop() æ–¹æ³•ä¸­
def _main_loop(self):
    # ... ç°æœ‰ä»£ç  ...

    # æ¯æ¬¡å¾ªç¯è®°å½•æƒç›Šæ›²çº¿
    try:
        balance = self.trader.get_balance()
        position = self.risk_manager.position
        unrealized_pnl = position.unrealized_pnl if position else 0
        equity = balance + unrealized_pnl

        db.log_equity(
            equity=equity,
            balance=balance,
            drawdown=self.risk_manager.current_drawdown,
            peak_equity=self.risk_manager.peak_equity
        )
    except Exception as e:
        logger.warning(f"è®°å½•æƒç›Šæ›²çº¿å¤±è´¥: {e}")
```

---

### å»ºè®® 3: å®ç°æ¯æ—¥ç»Ÿè®¡ï¼ˆæ¨èï¼‰

åœ¨ `bot.py` ä¸­æ·»åŠ æ¯æ—¥ç»Ÿè®¡ä»»åŠ¡ï¼š

```python
# bot.py - æ·»åŠ å®šæ—¶ä»»åŠ¡
def _update_daily_stats(self):
    """æ›´æ–°æ¯æ—¥ç»Ÿè®¡"""
    today = datetime.now().strftime("%Y-%m-%d")
    trades = db.get_today_trades()

    if not trades:
        return

    total_trades = len(trades)
    winning_trades = len([t for t in trades if (t.get('pnl') or 0) > 0])
    losing_trades = len([t for t in trades if (t.get('pnl') or 0) < 0])
    total_pnl = sum(t.get('pnl', 0) or 0 for t in trades)

    balance = self.trader.get_balance()

    db.update_daily_stats(
        date=today,
        total_trades=total_trades,
        winning_trades=winning_trades,
        losing_trades=losing_trades,
        total_pnl=total_pnl,
        max_drawdown=self.risk_manager.max_drawdown,
        starting_balance=self.starting_balance,
        ending_balance=balance
    )

# åœ¨ä¸»å¾ªç¯ä¸­æ¯å¤©è°ƒç”¨ä¸€æ¬¡
# ä¾‹å¦‚åœ¨æ¯å¤© 23:59 æˆ–æ¯æ¬¡å¾ªç¯æ£€æŸ¥æ—¥æœŸå˜åŒ–æ—¶è°ƒç”¨
```

---

### å»ºè®® 4: å®ç°é£é™©æŒ‡æ ‡è®°å½•ï¼ˆå¯é€‰ï¼‰

åœ¨ `risk_manager.py` ä¸­å®šæœŸæ›´æ–°é£é™©æŒ‡æ ‡ï¼š

```python
# risk_manager.py - æ·»åŠ æ–¹æ³•
def _update_risk_metrics(self):
    """æ›´æ–°é£é™©æŒ‡æ ‡"""
    trades = db.get_trades(limit=100)

    if len(trades) < 10:
        return  # äº¤æ˜“æ•°é‡ä¸è¶³ï¼Œè·³è¿‡

    winning = [t for t in trades if (t.get('pnl') or 0) > 0]
    losing = [t for t in trades if (t.get('pnl') or 0) < 0]

    if not trades:
        return

    win_rate = len(winning) / len(trades) if trades else 0

    total_win = sum(t.get('pnl', 0) or 0 for t in winning)
    total_loss = abs(sum(t.get('pnl', 0) or 0 for t in losing))
    profit_factor = total_win / total_loss if total_loss > 0 else 0

    db.log_risk_metrics(
        total_trades=len(trades),
        win_rate=win_rate,
        profit_factor=profit_factor,
        expectancy=sum(t.get('pnl', 0) or 0 for t in trades) / len(trades),
        max_drawdown=self.max_drawdown,
        kelly_fraction=self.kelly_fraction,
        consecutive_losses=self.consecutive_losses
    )

# åœ¨æ¯æ¬¡äº¤æ˜“åæˆ–å®šæœŸè°ƒç”¨
```

---

## ğŸ“‹ å®æ–½ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | ä»»åŠ¡ | é¢„æœŸæ•ˆæœ | å·¥ä½œé‡ |
|--------|------|----------|--------|
| ğŸŸ¢ P0 | éªŒè¯äº¤æ˜“è®°å½•åŠŸèƒ½ | ç¡®è®¤åŠŸèƒ½æ­£å¸¸ | 10åˆ†é’Ÿ |
| ğŸŸ¡ P1 | å®ç°æƒç›Šæ›²çº¿è®°å½• | å¯è§†åŒ–è´¦æˆ·å¢é•¿ | 30åˆ†é’Ÿ |
| ğŸŸ¡ P2 | å®ç°æ¯æ—¥ç»Ÿè®¡ | ç”Ÿæˆæ¯æ—¥æŠ¥å‘Š | 1å°æ—¶ |
| ğŸŸ¢ P3 | å®ç°é£é™©æŒ‡æ ‡è®°å½• | è¿½è¸ªé£é™©æŒ‡æ ‡ | 1å°æ—¶ |

---

## âœ… ç»“è®º

1. **æ­£å¸¸ä½¿ç”¨çš„è¡¨**: `signals` (61æ¡), `balance_snapshots` (11æ¡)
2. **æ ¸å¿ƒé—®é¢˜**: `trades` è¡¨ä¸ºç©ºï¼Œå› ä¸º `trader.close_position()` ä¸­ç¼ºå°‘ `db.log_trade()` è°ƒç”¨
3. **æ¬¡è¦é—®é¢˜**: `equity_curve`, `daily_stats`, `risk_metrics` æœªå®ç°è®°å½•åŠŸèƒ½
4. **å»ºè®®**: ä¼˜å…ˆä¿®å¤ `trades` è¡¨è®°å½•ï¼Œç„¶åå®ç°æƒç›Šæ›²çº¿å’Œæ¯æ—¥ç»Ÿè®¡

**æ€»ä½“è¯„ä¼°**: æ•°æ®åº“è¡¨è®¾è®¡å®Œå–„ï¼Œä½†éƒ¨åˆ†æ ¸å¿ƒåŠŸèƒ½ï¼ˆäº¤æ˜“è®°å½•ï¼‰æœªå®ç°ï¼Œéœ€è¦è¡¥å……ä»£ç ã€‚
