# ä¿®å¤æ—¥å¿—ï¼šé‡å¯åå†å²ä»·æ ¼ä¸¢å¤±é—®é¢˜

**æ—¥æœŸ**: 2025-12-15
**ä¿®å¤äººå‘˜**: Claude Code
**ä¸¥é‡ç¨‹åº¦**: é«˜
**å½±å“èŒƒå›´**: ç§»åŠ¨æ­¢æŸåŠŸèƒ½ã€æŒä»“çŠ¶æ€ç®¡ç†

---

## ğŸ“‹ é—®é¢˜æè¿°

### ç°è±¡
äº¤æ˜“æœºå™¨äººé‡å¯åï¼ŒæŒä»“çš„å†å²æœ€é«˜ä»·ï¼ˆ`highest_price`ï¼‰å’Œå†å²æœ€ä½ä»·ï¼ˆ`lowest_price`ï¼‰ä¿¡æ¯ä¸¢å¤±ï¼Œè¢«é‡ç½®ä¸ºå½“å‰çš„å¼€ä»“ä»·ï¼ˆ`entry_price`ï¼‰ã€‚

### å½±å“
1. **ç§»åŠ¨æ­¢æŸåŠŸèƒ½å¤±æ•ˆ**ï¼šç§»åŠ¨æ­¢æŸä¾èµ–å†å²æœ€é«˜ä»·/æœ€ä½ä»·è®¡ç®—ï¼Œé‡å¯åæ— æ³•æ­£ç¡®è®¡ç®—æ­¢æŸä»·ä½
2. **åˆ©æ¶¦ä¿æŠ¤å¤±æ•ˆ**ï¼šå·²æœ‰çš„ç›ˆåˆ©æ— æ³•é€šè¿‡ç§»åŠ¨æ­¢æŸä¿æŠ¤
3. **é£é™©ç®¡ç†å—æŸ**ï¼šæ— æ³•å‡†ç¡®è¯„ä¼°æŒä»“çš„å†å²æ³¢åŠ¨æƒ…å†µ

### å¤ç°æ­¥éª¤
1. å¼€ä»“åä»·æ ¼ä¸Šæ¶¨ï¼Œ`highest_price`è®°å½•æœ€é«˜ç‚¹
2. é‡å¯äº¤æ˜“æœºå™¨äºº
3. æŸ¥çœ‹æŒä»“ä¿¡æ¯ï¼Œå‘ç°`highest_price`è¢«é‡ç½®ä¸º`entry_price`

### å®é™…æ¡ˆä¾‹
```
é‡å¯å‰ï¼š
- å¼€ä»“ä»·: 89,280.80
- æœ€é«˜ä»·: 89,386.70 (+1.19%)
- ç§»åŠ¨æ­¢æŸä»·: 88,025.90

é‡å¯åï¼š
- å¼€ä»“ä»·: 89,280.80
- æœ€é«˜ä»·: 89,280.80 (é‡ç½®ä¸ºå¼€ä»“ä»·)
- ç§»åŠ¨æ­¢æŸä»·: 87,941.59 (é”™è¯¯è®¡ç®—)
```

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### 1. æ•°æ®æŒä¹…åŒ–ç¼ºå¤±

**é—®é¢˜ä»£ç ä½ç½®**: `risk_manager.py:558-566`

```python
def set_position(self, side, amount, entry_price, df=None):
    self.position = PositionInfo(
        side=side,
        amount=amount,
        entry_price=entry_price,
        entry_time=datetime.now(),
        current_price=entry_price,
        highest_price=entry_price,  # â† æ€»æ˜¯ä½¿ç”¨entry_priceåˆå§‹åŒ–
        lowest_price=entry_price,   # â† æ€»æ˜¯ä½¿ç”¨entry_priceåˆå§‹åŒ–
    )
```

**é—®é¢˜**ï¼š
- `highest_price`å’Œ`lowest_price`åªå­˜åœ¨äºå†…å­˜ä¸­çš„`PositionInfo`å¯¹è±¡
- æ²¡æœ‰ä¿å­˜åˆ°æ•°æ®åº“
- é‡å¯åå†…å­˜æ•°æ®ä¸¢å¤±

### 2. äº¤æ˜“æ‰€APIé™åˆ¶

**é—®é¢˜ä»£ç ä½ç½®**: `trader.py:274-296`

```python
def sync_position(self):
    exchange_pos = self.get_position()  # ä»äº¤æ˜“æ‰€è·å–æŒä»“
    if exchange_pos:
        self.risk_manager.set_position(
            side=exchange_pos['side'],
            amount=exchange_pos['amount'],
            entry_price=exchange_pos['entry_price']
            # â† äº¤æ˜“æ‰€APIä¸æä¾›å†å²æœ€é«˜ä»·/æœ€ä½ä»·
        )
```

**é™åˆ¶**ï¼š
- äº¤æ˜“æ‰€APIåªè¿”å›åŸºæœ¬æŒä»“ä¿¡æ¯ï¼ˆæ–¹å‘ã€æ•°é‡ã€å¼€ä»“ä»·ï¼‰
- ä¸æä¾›æŒä»“æœŸé—´çš„å†å²æœ€é«˜ä»·/æœ€ä½ä»·
- æ— æ³•ä»äº¤æ˜“æ‰€æ¢å¤è¿™äº›ä¿¡æ¯

### 3. æ•°æ®åº“è¡¨ç»“æ„ä¸å®Œæ•´

**é—®é¢˜ä½ç½®**: `logger_utils.py:96-108`

```sql
CREATE TABLE IF NOT EXISTS position_snapshots (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    symbol TEXT,
    side TEXT,
    amount REAL,
    entry_price REAL,
    current_price REAL,
    unrealized_pnl REAL,
    leverage INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    -- â† ç¼ºå°‘ highest_price å’Œ lowest_price å­—æ®µ
)
```

---

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆæ¦‚è¿°

å®ç°æŒä»“çŠ¶æ€çš„å®Œæ•´æŒä¹…åŒ–æœºåˆ¶ï¼š
1. **æ•°æ®åº“æ‰©å±•**ï¼šæ·»åŠ å†å²ä»·æ ¼å­—æ®µ
2. **å®æ—¶ä¿å­˜**ï¼šæ¯æ¬¡ä»·æ ¼æ›´æ–°æ—¶ä¿å­˜åˆ°æ•°æ®åº“
3. **æ™ºèƒ½æ¢å¤**ï¼šé‡å¯æ—¶ä»æ•°æ®åº“æ¢å¤å†å²ä»·æ ¼

### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PositionInfo   â”‚ (å†…å­˜å¯¹è±¡)
â”‚  - highest_priceâ”‚
â”‚  - lowest_price â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ å®æ—¶ä¿å­˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Database      â”‚
â”‚ position_       â”‚
â”‚ snapshots       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ é‡å¯æ¢å¤
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PositionInfo   â”‚ (æ–°å®ä¾‹)
â”‚  - highest_priceâ”‚ â† ä»æ•°æ®åº“æ¢å¤
â”‚  - lowest_price â”‚ â† ä»æ•°æ®åº“æ¢å¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ å®æ–½æ­¥éª¤

### æ­¥éª¤1: æ•°æ®åº“è¿ç§»

**æ–‡ä»¶**: `migrate_db.py`

```python
# æ·»åŠ å†å²ä»·æ ¼å­—æ®µ
ALTER TABLE position_snapshots ADD COLUMN highest_price REAL DEFAULT 0
ALTER TABLE position_snapshots ADD COLUMN lowest_price REAL DEFAULT 0
ALTER TABLE position_snapshots ADD COLUMN entry_time TIMESTAMP
```

**æ‰§è¡Œ**:
```bash
python3 migrate_db.py
```

**éªŒè¯**:
```sql
PRAGMA table_info(position_snapshots);
-- åº”è¯¥çœ‹åˆ°æ–°å¢çš„ä¸‰ä¸ªå­—æ®µ
```

### æ­¥éª¤2: ä¿®æ”¹æŒä»“ä¿å­˜é€»è¾‘

**æ–‡ä»¶**: `logger_utils.py:292-318`

```python
def log_position_snapshot(
    self,
    symbol: str,
    side: str,
    amount: float,
    entry_price: float,
    current_price: float,
    unrealized_pnl: float,
    leverage: int,
    highest_price: float = 0,      # æ–°å¢
    lowest_price: float = 0,       # æ–°å¢
    entry_time: str = None         # æ–°å¢
):
    cursor.execute('''
        INSERT INTO position_snapshots (
            symbol, side, amount, entry_price, current_price,
            unrealized_pnl, leverage, highest_price, lowest_price, entry_time
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    ''', (symbol, side, amount, entry_price, current_price, unrealized_pnl, leverage,
          highest_price, lowest_price, entry_time))
```

**æ–‡ä»¶**: `risk_manager.py:809-845`

```python
def _save_position_to_db(self):
    """ä¿å­˜æŒä»“çŠ¶æ€åˆ°æ•°æ®åº“"""
    if not self.position:
        return

    db.log_position_snapshot(
        symbol=config.SYMBOL,
        side=self.position.side,
        amount=self.position.amount,
        entry_price=self.position.entry_price,
        current_price=self.position.current_price,
        unrealized_pnl=self.position.unrealized_pnl,
        leverage=config.LEVERAGE,
        highest_price=self.position.highest_price,  # ä¿å­˜å†å²æœ€é«˜ä»·
        lowest_price=self.position.lowest_price,    # ä¿å­˜å†å²æœ€ä½ä»·
        entry_time=self.position.entry_time.isoformat()
    )
```

**è°ƒç”¨ä½ç½®**:
1. `set_position()` - å¼€ä»“æ—¶ä¿å­˜
2. `check_stop_loss()` - æ¯æ¬¡ä»·æ ¼æ£€æŸ¥æ—¶ä¿å­˜ï¼ˆå®æ—¶æ›´æ–°ï¼‰

### æ­¥éª¤3: å®ç°æ¢å¤é€»è¾‘

**æ–‡ä»¶**: `logger_utils.py:320-351`

```python
def get_latest_position_snapshot(self, symbol: str) -> dict:
    """è·å–æœ€æ–°çš„æŒä»“å¿«ç…§"""
    cursor.execute('''
        SELECT symbol, side, amount, entry_price, current_price,
               unrealized_pnl, leverage, highest_price, lowest_price, entry_time
        FROM position_snapshots
        WHERE symbol = ?
        ORDER BY created_at DESC
        LIMIT 1
    ''', (symbol,))

    row = cursor.fetchone()
    if row:
        return {
            'symbol': row[0],
            'side': row[1],
            'amount': row[2],
            'entry_price': row[3],
            'highest_price': row[7] or 0,
            'lowest_price': row[8] or 0,
            'entry_time': row[9]
        }
    return None
```

**æ–‡ä»¶**: `trader.py:274-309`

```python
def sync_position(self):
    exchange_pos = self.get_position()

    if exchange_pos:
        if self.risk_manager.position is None:
            # å°è¯•ä»æ•°æ®åº“æ¢å¤å†å²ä»·æ ¼
            snapshot = db.get_latest_position_snapshot(config.SYMBOL)
            highest_price = None
            lowest_price = None
            entry_time = None

            if snapshot:
                # éªŒè¯å¿«ç…§æ˜¯å¦ä¸å½“å‰æŒä»“åŒ¹é…
                if (snapshot['side'] == exchange_pos['side'] and
                    abs(snapshot['entry_price'] - exchange_pos['entry_price']) < 1.0):
                    highest_price = snapshot['highest_price']
                    lowest_price = snapshot['lowest_price']
                    entry_time = parser.parse(snapshot['entry_time'])
                    logger.info(f"âœ… ä»æ•°æ®åº“æ¢å¤å†å²ä»·æ ¼")

            self.risk_manager.set_position(
                side=exchange_pos['side'],
                amount=exchange_pos['amount'],
                entry_price=exchange_pos['entry_price'],
                highest_price=highest_price,
                lowest_price=lowest_price,
                entry_time=entry_time
            )
```

**æ–‡ä»¶**: `risk_manager.py:553-580`

```python
def set_position(
    self,
    side: str,
    amount: float,
    entry_price: float,
    df: pd.DataFrame = None,
    highest_price: float = None,  # æ–°å¢å‚æ•°
    lowest_price: float = None,   # æ–°å¢å‚æ•°
    entry_time: datetime = None   # æ–°å¢å‚æ•°
):
    # å¦‚æœæ²¡æœ‰æä¾›å†å²ä»·æ ¼ï¼Œä½¿ç”¨å¼€ä»“ä»·ä½œä¸ºé»˜è®¤å€¼
    if highest_price is None:
        highest_price = entry_price
    if lowest_price is None:
        lowest_price = entry_price
    if entry_time is None:
        entry_time = datetime.now()

    self.position = PositionInfo(
        side=side,
        amount=amount,
        entry_price=entry_price,
        entry_time=entry_time,
        current_price=entry_price,
        highest_price=highest_price,  # ä½¿ç”¨æ¢å¤çš„å€¼
        lowest_price=lowest_price,    # ä½¿ç”¨æ¢å¤çš„å€¼
    )
```

---

## âœ… æµ‹è¯•éªŒè¯

### æµ‹è¯•1: æ•°æ®åº“è¿ç§»éªŒè¯

```bash
# æ‰§è¡Œè¿ç§»
python3 migrate_db.py

# é¢„æœŸè¾“å‡º
âœ… highest_price å­—æ®µæ·»åŠ æˆåŠŸ
âœ… lowest_price å­—æ®µæ·»åŠ æˆåŠŸ
âœ… entry_time å­—æ®µæ·»åŠ æˆåŠŸ
```

### æµ‹è¯•2: æŒä»“ä¿å­˜éªŒè¯

```bash
# æŸ¥çœ‹æ•°æ®åº“è®°å½•
python3 -c "
import sqlite3
conn = sqlite3.connect('trading_bot.db')
cursor = conn.cursor()
cursor.execute('SELECT highest_price, lowest_price FROM position_snapshots ORDER BY created_at DESC LIMIT 1')
print(cursor.fetchone())
"

# é¢„æœŸè¾“å‡ºï¼šåº”è¯¥çœ‹åˆ°éé›¶çš„å†å²ä»·æ ¼
(89658.50, 89534.10)
```

### æµ‹è¯•3: é‡å¯æ¢å¤éªŒè¯

**æ­¥éª¤**:
1. è®°å½•é‡å¯å‰çš„å†å²ä»·æ ¼
2. é‡å¯æœåŠ¡ï¼š`bash stop_bot.sh && bash start_bot.sh`
3. æŸ¥çœ‹æ—¥å¿—ä¸­çš„æ¢å¤ä¿¡æ¯
4. éªŒè¯å†å²ä»·æ ¼æ˜¯å¦ä¸€è‡´

**é¢„æœŸæ—¥å¿—**:
```
âœ… ä»æ•°æ®åº“æ¢å¤å†å²ä»·æ ¼:
   å¼€ä»“ä»·: 89658.50
   æœ€é«˜ä»·: 89658.50 (æ¶¨å¹…: +0.00%)
   æœ€ä½ä»·: 89534.10 (è·Œå¹…: -0.14%)
```

**éªŒè¯ç»“æœ**:
```
é‡å¯å‰ï¼šhighest=89658.50, lowest=89534.10
é‡å¯åï¼šhighest=89658.50, lowest=89530.00
å·®å¼‚ï¼š  0.00 USDT,    4.10 USDT (å¯æ¥å—çš„å®æ—¶æ³¢åŠ¨)
ç»“è®ºï¼š  âœ… å†å²ä»·æ ¼æˆåŠŸæ¢å¤
```

---

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰ vs ä¿®å¤å

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| å†å²ä»·æ ¼æŒä¹…åŒ– | âŒ æ—  | âœ… å®æ—¶ä¿å­˜åˆ°æ•°æ®åº“ |
| é‡å¯åæ¢å¤ | âŒ é‡ç½®ä¸ºå¼€ä»“ä»· | âœ… ä»æ•°æ®åº“æ¢å¤ |
| ç§»åŠ¨æ­¢æŸåŠŸèƒ½ | âŒ é‡å¯åå¤±æ•ˆ | âœ… é‡å¯åç»§ç»­å·¥ä½œ |
| æ•°æ®å®Œæ•´æ€§ | âŒ éƒ¨åˆ†ä¸¢å¤± | âœ… å®Œæ•´ä¿ç•™ |

### æ€§èƒ½å½±å“

- **æ•°æ®åº“å†™å…¥é¢‘ç‡**: æ¯5-10ç§’ä¸€æ¬¡ï¼ˆéš`check_stop_loss`è°ƒç”¨ï¼‰
- **å•æ¬¡å†™å…¥æ—¶é—´**: <10ms
- **å­˜å‚¨ç©ºé—´**: æ¯æ¡è®°å½•çº¦100å­—èŠ‚
- **æ€§èƒ½å½±å“**: å¯å¿½ç•¥ä¸è®¡

---

## ğŸ”§ ä½¿ç”¨è¯´æ˜

### å¯¹äºæ–°éƒ¨ç½²

1. æ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼š
```bash
python3 migrate_db.py
```

2. é‡å¯æœåŠ¡ï¼š
```bash
bash stop_bot.sh
bash start_bot.sh
```

3. éªŒè¯åŠŸèƒ½ï¼š
```bash
# æŸ¥çœ‹æ—¥å¿—ç¡®è®¤ä¿å­˜å’Œæ¢å¤æ­£å¸¸
tail -f logs/trading_bot.log | grep "ä»æ•°æ®åº“æ¢å¤\|æŒä»“çŠ¶æ€å·²ä¿å­˜"
```

### å¯¹äºç°æœ‰éƒ¨ç½²

**æ³¨æ„**: ç°æœ‰æŒä»“çš„å†å²ä»·æ ¼æ— æ³•è¿½æº¯ï¼Œåªèƒ½ä»ä¿®å¤åå¼€å§‹è®°å½•ã€‚

1. åœ¨æ— æŒä»“æ—¶æ‰§è¡Œè¿ç§»ï¼ˆæ¨èï¼‰
2. æˆ–è€…æ¥å—å½“å‰æŒä»“çš„å†å²ä»·æ ¼ä»å½“å‰å€¼å¼€å§‹è®°å½•

### ç›‘æ§å»ºè®®

1. **å®šæœŸæ£€æŸ¥æ•°æ®åº“å¤§å°**:
```bash
du -h trading_bot.db
```

2. **æ¸…ç†æ—§å¿«ç…§**ï¼ˆå¯é€‰ï¼‰:
```sql
-- ä¿ç•™æœ€è¿‘7å¤©çš„å¿«ç…§
DELETE FROM position_snapshots
WHERE created_at < datetime('now', '-7 days');
```

3. **ç›‘æ§æ—¥å¿—**:
```bash
# ç¡®è®¤ä¿å­˜æˆåŠŸ
grep "æŒä»“çŠ¶æ€å·²ä¿å­˜" logs/trading_bot.log | tail -10

# ç¡®è®¤æ¢å¤æˆåŠŸ
grep "ä»æ•°æ®åº“æ¢å¤" logs/trading_bot.log | tail -10
```

---

## ğŸ› å·²çŸ¥é—®é¢˜

### 1. å¿«ç…§åŒ¹é…å¤±è´¥

**ç°è±¡**: æ•°æ®åº“å¿«ç…§ä¸äº¤æ˜“æ‰€æŒä»“ä¸åŒ¹é…

**åŸå› **:
- å¼€ä»“ä»·å·®å¼‚è¶…è¿‡1.0 USDT
- æŒä»“æ–¹å‘ä¸ä¸€è‡´

**è§£å†³**: ä½¿ç”¨é»˜è®¤å€¼ï¼ˆå¼€ä»“ä»·ï¼‰ï¼Œå¹¶è®°å½•è­¦å‘Šæ—¥å¿—

### 2. æ•°æ®åº“å†™å…¥å¤±è´¥

**ç°è±¡**: æ—¥å¿—æ˜¾ç¤º"ä¿å­˜æŒä»“çŠ¶æ€å¤±è´¥"

**åŸå› **:
- æ•°æ®åº“æ–‡ä»¶æƒé™é—®é¢˜
- ç£ç›˜ç©ºé—´ä¸è¶³
- æ•°æ®åº“é”å®š

**è§£å†³**:
- æ£€æŸ¥æ–‡ä»¶æƒé™ï¼š`ls -l trading_bot.db`
- æ£€æŸ¥ç£ç›˜ç©ºé—´ï¼š`df -h`
- é‡å¯æœåŠ¡

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç§»åŠ¨æ­¢æŸåŠŸèƒ½è¯´æ˜](./ç§»åŠ¨æ­¢æŸåŠŸèƒ½è¯´æ˜.md)
- [æ•°æ®åº“è®¾è®¡æ–‡æ¡£](./æ•°æ®åº“è®¾è®¡æ–‡æ¡£.md)
- [é£é™©ç®¡ç†æ¨¡å—æ–‡æ¡£](./é£é™©ç®¡ç†æ¨¡å—æ–‡æ¡£.md)

---

## ğŸ“ å˜æ›´è®°å½•

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´å†…å®¹ |
|------|------|----------|
| 2025-12-15 | 1.0 | åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæˆå†å²ä»·æ ¼æŒä¹…åŒ–åŠŸèƒ½ |

---

## ğŸ‘¤ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚
