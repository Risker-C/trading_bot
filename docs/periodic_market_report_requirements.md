# 定期市场分析通知功能需求文档

**文档版本:** 1.0
**创建日期:** 2025-12-15
**需求提出:** 用户
**需求分析:** Claude Sonnet 4.5

---

## 1. 背景与动机

### 1.1 业务背景
交易机器人需要7x24小时持续运行，监控市场并执行交易策略。在长时间运行过程中，用户需要：
- 确认机器人服务正常运行
- 了解当前市场状况
- 掌握机器人的运行状态
- 及时发现潜在问题

### 1.2 当前痛点
- **被动监控**: 用户需要主动查看日志或执行命令才能了解状态
- **缺乏心跳**: 无法快速判断机器人是否还在正常运行
- **信息滞后**: 可能错过重要的市场变化或系统异常
- **监控成本高**: 需要频繁登录服务器查看状态

### 1.3 解决方案
实现定期向飞书发送市场分析报告的功能，作为：
- **健康检查**: 定期收到消息即表示服务正常
- **信息推送**: 主动了解市场和持仓状况
- **异常预警**: 及时发现异常情况

---

## 2. 功能需求

### 2.1 核心功能
**FR-001: 定期发送市场分析报告**
- 系统应按照配置的时间间隔，自动向飞书发送市场分析报告
- 报告应包含完整的市场状态和系统运行信息
- 发送失败时应记录日志但不影响主流程

### 2.2 报告内容需求

#### FR-002: 系统运行状态
- 机器人运行时长
- 当前时间戳
- 系统版本信息（可选）

#### FR-003: 市场基本信息
- 交易对名称（如 BTC/USDT）
- 当前价格
- 24小时价格变化（涨跌幅）
- 24小时成交量

#### FR-004: 市场状态分析
- 市场状态（RANGING/TRENDING/VOLATILE）
- 市场状态置信度
- ADX 指标值
- 布林带宽度
- 趋势方向（上涨/下跌/震荡）
- 波动率水平
- 是否适合交易

#### FR-005: 策略信息
- 当前启用的策略列表
- 根据市场状态推荐的策略
- 策略切换说明（如有）

#### FR-006: 持仓信息
- 当前是否有持仓
- 如有持仓：
  - 持仓方向（多/空）
  - 持仓数量
  - 开仓价格
  - 当前价格
  - 未实现盈亏（USDT）
  - 未实现盈亏百分比
  - 持仓时长

#### FR-007: 账户信息
- 可用余额（USDT）
- 总权益（如有持仓）
- 保证金占用（如有持仓）

#### FR-008: 风险管理信息
- 当前止损价格（如有持仓）
- 当前止盈价格（如有持仓）
- 清算价格（如有持仓）
- 风险等级评估

#### FR-009: 近期交易统计
- 最近24小时交易次数
- 最近24小时盈亏
- 最近一笔交易信息（时间、方向、结果）

### 2.3 配置需求

#### FR-010: 时间间隔配置
- 支持配置报告发送间隔（分钟）
- 默认值：120分钟（2小时）
- 可配置范围：30分钟 - 720分钟（12小时）
- 支持通过配置文件修改

#### FR-011: 开关控制
- 支持启用/禁用定期报告功能
- 默认状态：启用
- 不影响其他通知功能（交易通知、错误通知等）

#### FR-012: 内容定制
- 支持配置报告包含的信息模块
- 支持配置报告的详细程度（简洁/标准/详细）

---

## 3. 非功能需求

### 3.1 性能要求
**NFR-001: 低延迟**
- 报告生成时间 < 2秒
- 不阻塞主交易循环
- 异步发送通知

**NFR-002: 低资源消耗**
- 内存占用增加 < 10MB
- CPU 占用增加 < 5%

### 3.2 可靠性要求
**NFR-003: 容错性**
- 发送失败不影响交易功能
- 网络异常时自动重试（最多3次）
- 失败后记录日志并继续运行

**NFR-004: 数据准确性**
- 所有数据必须实时获取
- 计算结果必须准确
- 时间戳必须精确

### 3.3 可维护性要求
**NFR-005: 代码质量**
- 模块化设计，易于扩展
- 完整的错误处理
- 详细的日志记录
- 清晰的代码注释

**NFR-006: 可测试性**
- 提供独立的测试脚本
- 支持模拟数据测试
- 支持手动触发测试

### 3.4 兼容性要求
**NFR-007: 系统兼容**
- 兼容现有的通知系统
- 不影响现有功能
- 支持飞书 Webhook API

---

## 4. 时间间隔分析

### 4.1 间隔选项分析

| 间隔 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| 30分钟 | 信息及时，快速发现问题 | 消息频繁，可能打扰 | 测试阶段，高频交易 |
| 1小时 | 较及时，不太频繁 | 仍然较多消息 | 活跃交易时段 |
| 2小时 | 平衡及时性和频率 | - | **推荐默认值** |
| 4小时 | 消息适中 | 可能延迟发现问题 | 低频交易策略 |
| 6小时 | 消息较少 | 信息滞后 | 长期持仓策略 |
| 12小时 | 消息很少 | 信息严重滞后 | 仅作为心跳检查 |

### 4.2 推荐配置
**默认间隔: 2小时（120分钟）**

**理由:**
1. **及时性**: 2小时内可以发现大部分问题
2. **适度性**: 每天12条消息，不会造成信息过载
3. **覆盖性**: 覆盖主要交易时段
4. **灵活性**: 用户可根据需求调整

### 4.3 特殊场景
- **测试阶段**: 建议使用30-60分钟间隔
- **稳定运行**: 可使用2-4小时间隔
- **长期持仓**: 可使用4-6小时间隔
- **仅心跳检查**: 可使用6-12小时间隔

---

## 5. 报告格式设计

### 5.1 消息结构
```
📊 市场分析报告
━━━━━━━━━━━━━━━━━━━━

⏰ 时间: 2025-12-15 10:00:00
🤖 运行时长: 2小时30分钟

💹 市场信息
━━━━━━━━━━━━━━━━━━━━
交易对: BTC/USDT
当前价格: $88,421.10
24h涨跌: +2.35% ↗️
24h成交量: 1.2B USDT

📈 市场状态
━━━━━━━━━━━━━━━━━━━━
状态: RANGING (震荡市)
置信度: 75%
ADX: 33.2
布林带宽度: 1.03%
趋势: 横盘整理
波动率: 中等
适合交易: ✅ 是

🎯 策略信息
━━━━━━━━━━━━━━━━━━━━
启用策略:
  • bollinger_breakthrough
  • rsi_divergence
  • kdj_cross
推荐策略: 均值回归策略

💼 持仓信息
━━━━━━━━━━━━━━━━━━━━
当前持仓: 无

💰 账户信息
━━━━━━━━━━━━━━━━━━━━
可用余额: 50.48 USDT

📊 24h交易统计
━━━━━━━━━━━━━━━━━━━━
交易次数: 0
盈亏: +0.00 USDT

━━━━━━━━━━━━━━━━━━━━
✅ 系统运行正常
```

### 5.2 有持仓时的格式
```
💼 持仓信息
━━━━━━━━━━━━━━━━━━━━
方向: 🟢 多单
数量: 0.001 BTC
开仓价: $87,500.00
当前价: $88,421.10
盈亏: +0.92 USDT (+10.52%)
持仓时长: 1小时23分钟

⚠️ 风险管理
止损价: $86,625.00 (-10%)
止盈价: $91,000.00 (+40%)
清算价: $78,750.00
```

---

## 6. 实现优先级

### P0 - 必须实现
- FR-001: 定期发送功能
- FR-003: 市场基本信息
- FR-004: 市场状态分析
- FR-006: 持仓信息
- FR-007: 账户信息
- FR-010: 时间间隔配置
- FR-011: 开关控制
- NFR-003: 容错性

### P1 - 应该实现
- FR-002: 系统运行状态
- FR-005: 策略信息
- FR-008: 风险管理信息
- NFR-001: 低延迟
- NFR-005: 代码质量

### P2 - 可以实现
- FR-009: 近期交易统计
- FR-012: 内容定制
- NFR-006: 可测试性

---

## 7. 成功标准

### 7.1 功能验收标准
- ✅ 能够按配置间隔自动发送报告
- ✅ 报告包含所有P0级别的信息
- ✅ 发送失败不影响交易功能
- ✅ 配置修改后立即生效
- ✅ 可以手动触发测试发送

### 7.2 质量验收标准
- ✅ 代码通过语法检查
- ✅ 所有测试用例通过
- ✅ 无内存泄漏
- ✅ 日志记录完整
- ✅ 错误处理完善

### 7.3 用户验收标准
- ✅ 消息格式清晰易读
- ✅ 信息准确无误
- ✅ 发送及时稳定
- ✅ 不影响正常使用

---

## 8. 风险与限制

### 8.1 技术风险
- **飞书API限流**: 发送过于频繁可能被限流
  - 缓解措施: 设置最小间隔30分钟
- **网络故障**: 网络异常导致发送失败
  - 缓解措施: 重试机制 + 日志记录
- **数据获取失败**: API调用失败导致数据不完整
  - 缓解措施: 异常处理 + 降级显示

### 8.2 业务风险
- **信息过载**: 消息过多导致用户忽略
  - 缓解措施: 合理的默认间隔 + 可配置
- **隐私泄露**: 账户信息通过飞书传输
  - 缓解措施: 使用HTTPS + 敏感信息脱敏

### 8.3 限制条件
- 依赖飞书 Webhook 配置
- 需要网络连接
- 受飞书API限制约束

---

## 9. 后续扩展

### 9.1 短期扩展（1-2周）
- 支持多种通知渠道（邮件、Telegram）
- 支持自定义报告模板
- 支持按市场状态调整发送频率

### 9.2 中期扩展（1-2月）
- 支持异常情况立即通知
- 支持交互式命令（通过飞书机器人）
- 支持历史报告查询

### 9.3 长期扩展（3-6月）
- 支持AI分析和建议
- 支持多账户聚合报告
- 支持自定义告警规则

---

## 10. 附录

### 10.1 相关文档
- 技术设计文档: `docs/periodic_market_report_design.md`
- 测试用例文档: `docs/periodic_market_report_test_cases.md`
- API文档: 飞书 Webhook API

### 10.2 参考资料
- 飞书开放平台文档
- 现有通知系统实现（logger_utils.py）
- 市场状态检测实现（market_state.py）

---

**文档状态:** ✅ 已完成
**审核状态:** 待审核
**下一步:** 创建技术设计文档
