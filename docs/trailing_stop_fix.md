# ç§»åŠ¨æ­¢æŸä¿®å¤åŠŸèƒ½è¯´æ˜æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜äº†ç§»åŠ¨æ­¢æŸ(Trailing Stop)å¤±æ•ˆé—®é¢˜çš„ä¿®å¤æ–¹æ¡ˆã€‚ç§»åŠ¨æ­¢æŸæ˜¯ä¸€ç§åŠ¨æ€æ­¢æŸæœºåˆ¶,å½“ä»·æ ¼æœæœ‰åˆ©æ–¹å‘ç§»åŠ¨æ—¶,æ­¢æŸä»·æ ¼ä¼šè·Ÿéšç§»åŠ¨,ä»è€Œé”å®šåˆ©æ¶¦å¹¶ç»™è¶‹åŠ¿ç•™å‡ºå‘å±•ç©ºé—´ã€‚

**é—®é¢˜æè¿°**: åŸé…ç½®ä¸­ç§»åŠ¨æ­¢æŸå›æ’¤æ¯”ä¾‹è®¾ç½®ä¸º2.5%,å¯¼è‡´åœ¨å°å¹…ç›ˆåˆ©(å¦‚0.5%ä»¥ä¸‹)æ—¶æ— æ³•å¯ç”¨ç§»åŠ¨æ­¢æŸä¿æŠ¤,ä½¿å¾—ç›ˆåˆ©ä»“ä½å®¹æ˜“å›ååˆ©æ¶¦ã€‚

**è§£å†³æ–¹æ¡ˆ**: å°†ç§»åŠ¨æ­¢æŸå›æ’¤æ¯”ä¾‹ä»2.5%é™ä½åˆ°0.5%,ä½¿ç§»åŠ¨æ­¢æŸæ›´å®¹æ˜“å¯ç”¨,æ›´åŠæ—¶åœ°ä¿æŠ¤å°é¢åˆ©æ¶¦ã€‚

## åŠŸèƒ½ç‰¹æ€§

1. **æ›´çµæ•çš„ç§»åŠ¨æ­¢æŸ**: 0.5%çš„å›æ’¤æ¯”ä¾‹ä½¿ç§»åŠ¨æ­¢æŸåœ¨æ›´å°çš„ç›ˆåˆ©å¹…åº¦ä¸‹å°±èƒ½å¯ç”¨
2. **æ›´å¥½çš„åˆ©æ¶¦ä¿æŠ¤**: åŠæ—¶é”å®šå°é¢åˆ©æ¶¦,é¿å…ç›ˆåˆ©å›å
3. **ä¿æŒè¶‹åŠ¿ç©ºé—´**: 0.5%çš„å›æ’¤ç©ºé—´ä»ç„¶ç»™è¶‹åŠ¿ç•™æœ‰åˆç†çš„æ³¢åŠ¨ç©ºé—´
4. **æ˜¾ç¤ºæ ¼å¼ä¼˜åŒ–**: ä¿®å¤äº†æ—¥å¿—ä¸­ç§»åŠ¨æ­¢æŸæ˜¾ç¤ºä¸º"0%"çš„é—®é¢˜,ç°åœ¨æ­£ç¡®æ˜¾ç¤º"0.5%"

## é…ç½®è¯´æ˜

### é…ç½®æ–‡ä»¶ä½ç½®
`config.py`

### é…ç½®é¡¹è¯¦è§£

#### TRAILING_STOP_PERCENT
- **ä½ç½®**: config.py:70
- **ä¿®æ”¹å‰**: `0.025` (2.5%)
- **ä¿®æ”¹å**: `0.005` (0.5%)
- **è¯´æ˜**: ç§»åŠ¨æ­¢æŸå›æ’¤æ¯”ä¾‹,è¡¨ç¤ºä»æœ€é«˜ä»·(å¤šä»“)æˆ–æœ€ä½ä»·(ç©ºä»“)å›æ’¤å¤šå°‘ç™¾åˆ†æ¯”æ—¶è§¦å‘æ­¢æŸ

**è®¡ç®—å…¬å¼**:
- å¤šä»“: `trailing_stop_price = highest_price Ã— (1 - TRAILING_STOP_PERCENT)`
- ç©ºä»“: `trailing_stop_price = lowest_price Ã— (1 + TRAILING_STOP_PERCENT)`

**å¯ç”¨æ¡ä»¶**:
- å¤šä»“: `trailing_stop_price > entry_price` (ç§»åŠ¨æ­¢æŸä»·å¿…é¡»é«˜äºå¼€ä»“ä»·)
- ç©ºä»“: `trailing_stop_price < entry_price` (ç§»åŠ¨æ­¢æŸä»·å¿…é¡»ä½äºå¼€ä»“ä»·)

### æ˜¾ç¤ºæ ¼å¼ä¿®å¤

#### bot.py:153
- **ä¿®æ”¹å‰**: `logger.info(f"   ç§»åŠ¨æ­¢æŸ: {config.TRAILING_STOP_PERCENT:.0%}")`
- **ä¿®æ”¹å**: `logger.info(f"   ç§»åŠ¨æ­¢æŸ: {config.TRAILING_STOP_PERCENT:.1%}")`
- **è¯´æ˜**: å°†æ ¼å¼åŒ–ä»`.0%`æ”¹ä¸º`.1%`,ä½¿0.5%èƒ½æ­£ç¡®æ˜¾ç¤ºè€Œä¸æ˜¯è¢«å››èˆäº”å…¥ä¸º0%

## ä½¿ç”¨æ–¹æ³•

### 1. é…ç½®å·²è‡ªåŠ¨ç”Ÿæ•ˆ
ä¿®å¤åçš„é…ç½®å·²ç»åº”ç”¨åˆ°ç³»ç»Ÿä¸­,æ— éœ€æ‰‹åŠ¨æ“ä½œã€‚

### 2. éªŒè¯é…ç½®
å¯åŠ¨æœºå™¨äººå,æŸ¥çœ‹æ—¥å¿—ä¸­çš„é…ç½®ä¿¡æ¯:
```
ğŸ“‹ å½“å‰é…ç½®:
   ...
   ç§»åŠ¨æ­¢æŸ: 0.5%
   ...
```

### 3. ç›‘æ§ç§»åŠ¨æ­¢æŸå·¥ä½œçŠ¶æ€
å½“æœ‰æŒä»“æ—¶,ç³»ç»Ÿä¼šè‡ªåŠ¨è®¡ç®—ç§»åŠ¨æ­¢æŸä»·æ ¼ã€‚æŸ¥çœ‹æ—¥å¿—ä¸­çš„ç§»åŠ¨æ­¢æŸä¿¡æ¯:
```
[ç§»åŠ¨æ­¢æŸ] TRAILING_STOP_PERCENT: 0.005
[ç§»åŠ¨æ­¢æŸ] é¢„æœŸå€¼(å¤šä»“): 87091.10 Ã— 0.995 = 86655.64
[ç§»åŠ¨æ­¢æŸ] å®é™…å€¼: 86655.64
[ç§»åŠ¨æ­¢æŸ] å¯ç”¨æ¡ä»¶: 86655.64 > 86756.10 = False
```

### 4. ç§»åŠ¨æ­¢æŸå¯ç”¨ç¤ºä¾‹
å‡è®¾å¼€ä»“ä»·ä¸º86756.10,å½“ä»·æ ¼ä¸Šæ¶¨åˆ°87200æ—¶:
- æœ€é«˜ä»·: 87200
- ç§»åŠ¨æ­¢æŸä»·: 87200 Ã— 0.995 = 86724
- å¯ç”¨æ¡ä»¶: 86724 > 86756.10 = **False** (è¿˜æœªå¯ç”¨)

å½“ä»·æ ¼ç»§ç»­ä¸Šæ¶¨åˆ°87300æ—¶:
- æœ€é«˜ä»·: 87300
- ç§»åŠ¨æ­¢æŸä»·: 87300 Ã— 0.995 = 86863.5
- å¯ç”¨æ¡ä»¶: 86863.5 > 86756.10 = **True** (å·²å¯ç”¨)
- æ­¤æ—¶å¦‚æœä»·æ ¼å›è½åˆ°86863.5,å°†è§¦å‘ç§»åŠ¨æ­¢æŸå¹³ä»“

## æŠ€æœ¯å®ç°

### æ ¸å¿ƒæ¨¡å—
- **risk_manager.py**: ç§»åŠ¨æ­¢æŸè®¡ç®—é€»è¾‘
  - `calculate_trailing_stop()` (lines 603-622): è®¡ç®—ç§»åŠ¨æ­¢æŸä»·æ ¼
  - å¤šä»“é€»è¾‘ (lines 610-615): ä»æœ€é«˜ä»·å›æ’¤è®¡ç®—
  - ç©ºä»“é€»è¾‘ (lines 617-622): ä»æœ€ä½ä»·å›æ’¤è®¡ç®—

### æ•°æ®æµç¨‹
1. **ä»·æ ¼æ›´æ–°**: ç³»ç»ŸæŒç»­ç›‘æ§å½“å‰ä»·æ ¼
2. **æå€¼è¿½è¸ª**: æ›´æ–°æŒä»“çš„æœ€é«˜ä»·(å¤šä»“)æˆ–æœ€ä½ä»·(ç©ºä»“)
3. **æ­¢æŸè®¡ç®—**: æ ¹æ®æå€¼å’Œå›æ’¤æ¯”ä¾‹è®¡ç®—ç§»åŠ¨æ­¢æŸä»·
4. **æ¡ä»¶æ£€æŸ¥**: éªŒè¯ç§»åŠ¨æ­¢æŸä»·æ˜¯å¦æ»¡è¶³å¯ç”¨æ¡ä»¶
5. **è§¦å‘å¹³ä»“**: å½“ä»·æ ¼è§¦åŠç§»åŠ¨æ­¢æŸä»·æ—¶æ‰§è¡Œå¹³ä»“

### å…³é”®ä»£ç 
```python
def calculate_trailing_stop(
    self,
    current_price: float,
    position: PositionInfo
) -> float:
    """è®¡ç®—ç§»åŠ¨æ­¢æŸä»·æ ¼"""
    if position.side == 'long':
        # å¤šä»“ï¼šä»æœ€é«˜ä»·å›æ’¤
        trailing_price = position.highest_price * (1 - config.TRAILING_STOP_PERCENT)
        # å¿…é¡»é«˜äºå¼€ä»“ä»·æ‰å¯ç”¨
        if trailing_price > position.entry_price:
            return trailing_price
        return 0
    else:
        # ç©ºä»“ï¼šä»æœ€ä½ä»·å›æ’¤
        trailing_price = position.lowest_price * (1 + config.TRAILING_STOP_PERCENT)
        # å¿…é¡»ä½äºå¼€ä»“ä»·æ‰å¯ç”¨
        if trailing_price < position.entry_price:
            return trailing_price
        return 0
```

## æ•…éšœæ’æŸ¥

### é—®é¢˜1: ç§»åŠ¨æ­¢æŸä»ç„¶æ˜¾ç¤ºä¸º0%
**åŸå› **: æœåŠ¡æœªé‡å¯,æ—§é…ç½®ä»åœ¨ä½¿ç”¨
**è§£å†³**:
```bash
./stop_bot.sh
./start_bot.sh
```

### é—®é¢˜2: ç§»åŠ¨æ­¢æŸæœªå¯ç”¨
**åŸå› **: å½“å‰ç›ˆåˆ©å¹…åº¦ä¸è¶³ä»¥æ»¡è¶³å¯ç”¨æ¡ä»¶
**æ£€æŸ¥**:
- æŸ¥çœ‹æ—¥å¿—ä¸­çš„ç§»åŠ¨æ­¢æŸè®¡ç®—ä¿¡æ¯
- ç¡®è®¤ `trailing_stop_price > entry_price` (å¤šä»“) æˆ– `trailing_stop_price < entry_price` (ç©ºä»“)
**è¯´æ˜**: è¿™æ˜¯æ­£å¸¸ç°è±¡,éœ€è¦ç­‰å¾…ä»·æ ¼è¿›ä¸€æ­¥æœæœ‰åˆ©æ–¹å‘ç§»åŠ¨

### é—®é¢˜3: ç§»åŠ¨æ­¢æŸè¿‡äºæ•æ„Ÿ,é¢‘ç¹è§¦å‘
**åŸå› **: 0.5%çš„å›æ’¤æ¯”ä¾‹å¯èƒ½å¯¹æŸäº›æ³¢åŠ¨è¾ƒå¤§çš„å¸‚åœºè¿‡äºæ•æ„Ÿ
**è§£å†³**: æ ¹æ®å®é™…äº¤æ˜“æƒ…å†µ,å¯ä»¥é€‚å½“è°ƒæ•´ `TRAILING_STOP_PERCENT` çš„å€¼
**å»ºè®®èŒƒå›´**: 0.003 (0.3%) ~ 0.01 (1.0%)

## æ€§èƒ½ä¼˜åŒ–

### 1. å›æ’¤æ¯”ä¾‹è°ƒä¼˜
æ ¹æ®ä¸åŒçš„å¸‚åœºçŠ¶æ€å’Œäº¤æ˜“å‘¨æœŸ,å¯ä»¥åŠ¨æ€è°ƒæ•´å›æ’¤æ¯”ä¾‹:
- **é«˜æ³¢åŠ¨å¸‚åœº**: å¢åŠ åˆ°0.8%-1.0%,é¿å…è¢«æ­£å¸¸æ³¢åŠ¨æ­¢æŸ
- **ä½æ³¢åŠ¨å¸‚åœº**: ä¿æŒ0.5%æˆ–é™ä½åˆ°0.3%,æ›´åŠæ—¶ä¿æŠ¤åˆ©æ¶¦
- **è¶‹åŠ¿å¸‚åœº**: å¢åŠ åˆ°1.0%-1.5%,ç»™è¶‹åŠ¿æ›´å¤šå‘å±•ç©ºé—´
- **éœ‡è¡å¸‚åœº**: ä¿æŒ0.5%,å¿«é€Ÿé”å®šåˆ©æ¶¦

### 2. ä¸å…¶ä»–æ­¢æŸæœºåˆ¶é…åˆ
ç§»åŠ¨æ­¢æŸåº”ä¸å›ºå®šæ­¢æŸå’Œæ­¢ç›ˆé…åˆä½¿ç”¨:
- **å›ºå®šæ­¢æŸ** (2%): é˜²æ­¢å¤§å¹…äºæŸ
- **ç§»åŠ¨æ­¢æŸ** (0.5%): ä¿æŠ¤å·²æœ‰åˆ©æ¶¦
- **å›ºå®šæ­¢ç›ˆ** (4%): ç¡®ä¿ç›®æ ‡åˆ©æ¶¦

### 3. ç›‘æ§å’Œè°ƒæ•´
å®šæœŸæŸ¥çœ‹äº¤æ˜“å†å²,åˆ†æç§»åŠ¨æ­¢æŸçš„è§¦å‘æƒ…å†µ:
```sql
SELECT * FROM trades
WHERE exit_reason LIKE '%ç§»åŠ¨æ­¢æŸ%'
ORDER BY exit_time DESC
LIMIT 20;
```

## æ‰©å±•å¼€å‘

### 1. åŠ¨æ€ç§»åŠ¨æ­¢æŸ
æ ¹æ®å¸‚åœºæ³¢åŠ¨ç‡åŠ¨æ€è°ƒæ•´å›æ’¤æ¯”ä¾‹:
```python
# åœ¨ config.py ä¸­æ·»åŠ 
DYNAMIC_TRAILING_STOP = True
TRAILING_STOP_BASE = 0.005  # åŸºç¡€å›æ’¤æ¯”ä¾‹
TRAILING_STOP_VOLATILITY_FACTOR = 1.5  # æ³¢åŠ¨ç‡ç³»æ•°

# åœ¨ risk_manager.py ä¸­å®ç°
def get_dynamic_trailing_stop_percent(self, volatility: float) -> float:
    """æ ¹æ®æ³¢åŠ¨ç‡åŠ¨æ€è®¡ç®—å›æ’¤æ¯”ä¾‹"""
    if config.DYNAMIC_TRAILING_STOP:
        return config.TRAILING_STOP_BASE * (1 + volatility * config.TRAILING_STOP_VOLATILITY_FACTOR)
    return config.TRAILING_STOP_PERCENT
```

### 2. åˆ†çº§ç§»åŠ¨æ­¢æŸ
æ ¹æ®ç›ˆåˆ©å¹…åº¦ä½¿ç”¨ä¸åŒçš„å›æ’¤æ¯”ä¾‹:
```python
# ç›ˆåˆ©0-1%: 0.3%å›æ’¤
# ç›ˆåˆ©1-2%: 0.5%å›æ’¤
# ç›ˆåˆ©2%+: 0.8%å›æ’¤
def get_tiered_trailing_stop(self, profit_pct: float) -> float:
    if profit_pct < 0.01:
        return 0.003
    elif profit_pct < 0.02:
        return 0.005
    else:
        return 0.008
```

### 3. æ—¶é—´è¡°å‡ç§»åŠ¨æ­¢æŸ
æŒä»“æ—¶é—´è¶Šé•¿,å›æ’¤æ¯”ä¾‹è¶Šå°:
```python
def get_time_decay_trailing_stop(self, hold_minutes: int) -> float:
    """æŒä»“æ—¶é—´è¶Šé•¿,æ­¢æŸè¶Šç´§"""
    base = config.TRAILING_STOP_PERCENT
    if hold_minutes > 60:  # è¶…è¿‡1å°æ—¶
        return base * 0.6  # æ”¶ç´§åˆ°60%
    elif hold_minutes > 30:  # è¶…è¿‡30åˆ†é’Ÿ
        return base * 0.8  # æ”¶ç´§åˆ°80%
    return base
```

## æœ€ä½³å®è·µ

### 1. é…ç½®å»ºè®®
- **ä¿å®ˆå‹**: 0.3% - å¿«é€Ÿé”å®šåˆ©æ¶¦,é€‚åˆéœ‡è¡å¸‚
- **å¹³è¡¡å‹**: 0.5% - æœ¬æ¬¡ä¿®å¤é‡‡ç”¨çš„å€¼,é€‚åˆå¤§å¤šæ•°æƒ…å†µ
- **æ¿€è¿›å‹**: 1.0% - ç»™è¶‹åŠ¿æ›´å¤šç©ºé—´,é€‚åˆå¼ºè¶‹åŠ¿å¸‚

### 2. ç›‘æ§å»ºè®®
- æ¯æ—¥æŸ¥çœ‹ç§»åŠ¨æ­¢æŸè§¦å‘æ¬¡æ•°å’Œå¹³å‡ç›ˆåˆ©
- åˆ†ææ˜¯å¦æœ‰è¿‡æ—©æ­¢æŸå¯¼è‡´é”™å¤±å¤§è¶‹åŠ¿çš„æƒ…å†µ
- æ ¹æ®ç»Ÿè®¡æ•°æ®è°ƒæ•´å›æ’¤æ¯”ä¾‹

### 3. é£é™©æ§åˆ¶
- ç§»åŠ¨æ­¢æŸä¸åº”æ›¿ä»£å›ºå®šæ­¢æŸ
- ç¡®ä¿å›ºå®šæ­¢æŸå§‹ç»ˆæœ‰æ•ˆ,é˜²æ­¢æç«¯è¡Œæƒ…
- å®šæœŸå›æµ‹ä¸åŒå›æ’¤æ¯”ä¾‹çš„æ•ˆæœ

### 4. æµ‹è¯•å»ºè®®
- åœ¨å½±å­æ¨¡å¼ä¸‹æµ‹è¯•æ–°çš„å›æ’¤æ¯”ä¾‹
- å¯¹æ¯”ä¸åŒå›æ’¤æ¯”ä¾‹çš„èƒœç‡å’Œç›ˆäºæ¯”
- è‡³å°‘è§‚å¯Ÿ100ç¬”äº¤æ˜“åå†è°ƒæ•´å‚æ•°

## æ›´æ–°æ—¥å¿—

### v1.0.0 (2025-12-18)
- **ä¿®å¤**: å°† TRAILING_STOP_PERCENT ä» 0.025 (2.5%) é™ä½åˆ° 0.005 (0.5%)
- **ä¿®å¤**: ä¿®å¤æ—¥å¿—æ˜¾ç¤ºæ ¼å¼,ä» `.0%` æ”¹ä¸º `.1%`,æ­£ç¡®æ˜¾ç¤º0.5%
- **ä¼˜åŒ–**: ä½¿ç§»åŠ¨æ­¢æŸæ›´å®¹æ˜“å¯ç”¨,æ›´åŠæ—¶ä¿æŠ¤å°é¢åˆ©æ¶¦
- **æµ‹è¯•**: é€šè¿‡æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹,æœåŠ¡è¿è¡Œæ­£å¸¸

### ä¿®å¤å‰åå¯¹æ¯”

#### ä¿®å¤å‰ (2.5%å›æ’¤)
- å¼€ä»“ä»·: 86756.10
- æœ€é«˜ä»·: 87091.10 (ç›ˆåˆ©0.386%)
- ç§»åŠ¨æ­¢æŸä»·: 87091.10 Ã— 0.975 = 84913.82
- å¯ç”¨æ¡ä»¶: 84913.82 > 86756.10 = **False** âŒ
- ç»“æœ: ç§»åŠ¨æ­¢æŸæœªå¯ç”¨,æ— æ³•ä¿æŠ¤åˆ©æ¶¦

#### ä¿®å¤å (0.5%å›æ’¤)
- å¼€ä»“ä»·: 86756.10
- æœ€é«˜ä»·: 87300 (ç›ˆåˆ©0.627%)
- ç§»åŠ¨æ­¢æŸä»·: 87300 Ã— 0.995 = 86863.5
- å¯ç”¨æ¡ä»¶: 86863.5 > 86756.10 = **True** âœ…
- ç»“æœ: ç§»åŠ¨æ­¢æŸå·²å¯ç”¨,ä¿æŠ¤åˆ©æ¶¦

## ç›¸å…³æ–‡æ¡£

- [é£é™©ç®¡ç†æ¨¡å—æ–‡æ¡£](risk_manager.md) (å¦‚æœå­˜åœ¨)
- [é…ç½®æ–‡ä»¶è¯´æ˜](config.md) (å¦‚æœå­˜åœ¨)
- [äº¤æ˜“ç­–ç•¥æ–‡æ¡£](strategies.md) (å¦‚æœå­˜åœ¨)

## æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®,è¯·æŸ¥çœ‹:
- é¡¹ç›®æ—¥å¿—: `/root/trading_bot/logs/bot_runtime.log`
- æµ‹è¯•è„šæœ¬: `/root/trading_bot/scripts/test_trailing_stop.py`
- é…ç½®æ–‡ä»¶: `/root/trading_bot/config.py`
- æ ¸å¿ƒä»£ç : `/root/trading_bot/risk_manager.py`
